<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Business</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* All existing CSS styles remain the same except the updated parts below */
        
        /* UPDATED: Bill Links Modal Styles - Side by Side Images */
        .bill-links-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .bill-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px;
        }
        .bill-link-grid-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
            text-align: center;
        }
        .bill-link-grid-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .bill-link-grid-placeholder {
            width: 100%;
            height: 150px;
            background: #e9ecef;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
        .bill-link-grid-info {
            font-size: 12px;
            color: #6c757d;
        }
        .bill-link-grid-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Keep all other existing styles the same */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .member-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .member-name {
            font-weight: 600;
            font-size: 16px;
            flex-grow: 1;
        }
        .member-balance {
            font-weight: bold;
            font-size: 16px;
            margin-right: 15px;
        }
        .member-actions {
            position: relative;
        }
        .dropdown-menu {
            min-width: 120px;
        }
        .balance-summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .remaining-balance {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #28a745;
            margin: 10px 0;
        }
        .transaction-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            position: relative;
            padding-right: 50px;
        }
        .transaction-item.cash-out {
            border-left-color: #dc3545;
        }
        .back-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-right: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .transaction-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 10;
        }
        .transaction-actions .btn {
            padding: 2px 8px;
            font-size: 14px;
            background: transparent;
            border: none;
            color: #6c757d;
        }
        .transaction-actions .btn:hover {
            background: #f8f9fa;
            color: #000;
        }
        .date-filter {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-summary {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .filter-toggle {
            background: none;
            border: none;
            color: #007bff;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 0;
        }
        /* Updated Share Card Style - Simple and Clean */
        .share-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            font-family: Arial, sans-serif;
        }
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .share-party-name {
            font-size: 18px;
            font-weight: bold;
        }
        .share-date {
            color: #666;
        }
        .share-amount {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
        }
        .share-details {
            margin: 15px 0;
        }
        .share-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }
        .share-detail-row:last-child {
            border-bottom: none;
        }
        .share-current-balance {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .share-comment {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        .share-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 12px;
        }
        /* Day Summary Share Card */
        .day-summary-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 0 auto;
        }
        .day-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .day-summary-member {
            font-size: 20px;
            font-weight: bold;
        }
        .day-summary-date {
            color: #666;
            font-size: 16px;
        }
        .day-summary-divider {
            height: 1px;
            background: #ddd;
            margin: 15px 0;
        }
        .day-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
        }
        .day-summary-label {
            font-weight: normal;
        }
        .day-summary-amount {
            font-weight: bold;
        }
        .day-summary-positive {
            color: #28a745;
        }
        .day-summary-negative {
            color: #dc3545;
        }
        .day-summary-current-balance {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #28a745;
        }
        .day-summary-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
            color: #666;
            font-size: 12px;
        }
        .date-share-button {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 10px;
            cursor: pointer;
        }
        .date-share-button:hover {
            background: #5a6268;
        }
        
        /* Backup System Styles */
        .backup-status-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        .backup-option-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .backup-option-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .backup-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .backup-option-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .backup-option-desc {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .backup-success-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* NEW STYLES FOR BILL ATTACHMENTS AND SEARCH */
        .bill-attachments-section {
            margin-top: 10px;
            border-top: 1px dashed #ddd;
            padding-top: 10px;
        }
        .bill-link-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .bill-link-preview {
            width: 24px;
            height: 24px;
            object-fit: cover;
            border-radius: 3px;
            margin-right: 8px;
            cursor: pointer;
        }
        .bill-link-url {
            flex-grow: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #007bff;
            text-decoration: none;
        }
        .bill-link-url:hover {
            text-decoration: underline;
        }
        .bill-link-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            margin-left: 5px;
        }
        .transaction-links-container {
            margin-top: 8px;
            font-size: 12px;
        }
        .search-filter-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* UPDATED STYLES FOR IMAGE PREVIEW IN FORM - SIDE BY SIDE */
        .bill-link-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }
        .bill-link-input {
            flex: 1;
            display: none; /* Hide the input field by default */
        }
        .image-previews-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview-item {
            position: relative;
            width: calc(50% - 5px); /* Two images per row */
            min-width: 150px;
        }
        .image-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .preview-loading {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        .preview-error {
            color: #dc3545;
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }
        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pcloud-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #856404;
        }
        .add-link-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* FIX for modal scroll issue */
        .modal {
            overflow-y: auto;
        }
        .modal-open {
            overflow: auto;
            padding-right: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <!-- Header -->
        <div class="bg-primary text-white p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="back-button text-white" id="backButton" style="display: none;">‚Üê</button>
                    <h4 class="mb-0" id="headerTitle">Partnership Business</h4>
                </div>
                <div>
                    <button class="btn btn-light btn-sm me-1" onclick="downloadPDF()">üìÑ PDF</button>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#backupModal">üíæ Backup</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Member List View -->
            <div id="memberListView" class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Members</h5>
                    <button class="btn btn-primary btn-sm" onclick="showAddMemberForm()">+ Add Member</button>
                </div>
                
                <div id="memberList">
                    <!-- Members will be loaded here -->
                </div>
            </div>

            <!-- Member Detail View (Hidden by default) -->
            <div id="memberDetailView" style="display: none;" class="p-3">
                <!-- Filter Icon and Summary -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0" id="transactionHistoryTitle">Transaction History</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleDateFilter()">
                            üîç Filter
                        </button>
                        <div class="btn-group ms-1">
                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                Quick Filters
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="applyQuickFilter('today')">Today</a></li>
                                <li><a class="dropdown-item" href="#" onclick="applyQuickFilter('yesterday')">Yesterday</a></li>
                                <li><a class="dropdown-item" href="#" onclick="applyQuickFilter('thisMonth')">This Month</a></li>
                                <li><a class="dropdown-item" href="#" onclick="applyQuickFilter('threeMonths')">Three Months</a></li>
                                <li><a class="dropdown-item" href="#" onclick="applyQuickFilter('oneYear')">One Year</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Search Filter Section -->
                <div class="search-filter-section">
                    <h6>Search Transactions</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="Search by keyword (name, amount, remark, etc.)">
                        <button class="btn btn-primary" onclick="applySearchFilter()">Search</button>
                        <button class="btn btn-outline-secondary" onclick="clearSearchFilter()">Clear</button>
                    </div>
                </div>

                <!-- Date Range Filter Summary -->
                <div class="filter-summary" id="filterSummary" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Date Range:</strong> 
                            <span id="filterRangeText"></span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearDateFilter()">Clear Filter</button>
                        </div>
                    </div>
                </div>

                <!-- Date Range Filter (Collapsible) -->
                <div class="date-filter" id="dateFilterSection" style="display: none;">
                    <h6>Filter Transactions by Date</h6>
                    <div class="row">
                        <div class="col-md-5 mb-2">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="filterFromDate">
                        </div>
                        <div class="col-md-5 mb-2">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="filterToDate">
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyDateFilter()">Apply</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-success btn-sm" onclick="downloadFilteredPDF()">üìÑ Download Filtered PDF</button>
                    </div>
                </div>

                <!-- Balance Summary -->
                <div class="balance-summary">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Opening Balance</small>
                            <div class="fw-bold" id="detailOpeningBalance">0</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Total Cash In</small>
                            <div class="fw-bold text-success" id="detailTotalIn">0</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Total Cash Out</small>
                            <div class="fw-bold text-danger" id="detailTotalOut">0</div>
                        </div>
                    </div>
                    <div class="remaining-balance" id="detailRemainingBalance">0</div>
                </div>

                <!-- Transaction Buttons -->
                <div class="row mb-3">
                    <div class="col-6">
                        <button class="btn btn-success w-100" onclick="showTransactionForm('cash_in')">üí∞ Cash In</button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-danger w-100" onclick="showTransactionForm('cash_out')">üí∏ Cash Out</button>
                    </div>
                </div>

                <!-- Transaction History -->
                <div id="transactionHistory">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Add Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeTransactionModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionFormElement">
                        <input type="hidden" id="transactionType">
                        <input type="hidden" id="editingTransactionId" value="">
                        
                        <div class="mb-3">
                            <label class="form-label">Amount *</label>
                            <input type="number" class="form-control" id="amount" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Remark</label>
                            <textarea class="form-control" id="comment" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="transactionDate">
                        </div>
                        
                        <!-- Bill Attachments Section with Image Preview -->
                        <div class="bill-attachments-section">
                            <label class="form-label">Bill Links (Optional)</label>
                            
                            <!-- Image Previews Container -->
                            <div class="image-previews-container" id="imagePreviewsContainer">
                                <!-- Image previews will be added here side by side -->
                            </div>
                            
                            <!-- Add Link Section -->
                            <div class="add-link-section">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="newBillLinkInput" placeholder="Paste image URL here">
                                    <button type="button" class="btn btn-primary" onclick="addBillLinkFromInput()">Add Image</button>
                                </div>
                                <small class="form-text text-muted">
                                    Paste image URLs to add bill previews. Images will display side by side.
                                    For pCloud links, we'll try to generate a preview.
                                </small>
                            </div>
                            
                            <!-- Hidden container for storing actual links -->
                            <div id="billLinksContainer" style="display: none;">
                                <!-- Actual bill links will be stored here as hidden inputs -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeTransactionModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()" id="saveTransactionBtn">Save Transaction</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Updated Share Transaction Modal - Simple and Clean -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="share-card">
                        <div class="share-header">
                            <div class="share-party-name" id="sharePartyName">Member Name</div>
                            <div class="share-date" id="shareDate">Date</div>
                        </div>
                        
                        <div class="share-amount" id="shareAmount">
                            0
                        </div>
                        
                        <div class="share-details">
                            <div class="share-detail-row">
                                <span>Last Balance</span>
                                <span id="shareOpeningBalance">0</span>
                            </div>
                            <div class="share-detail-row">
                                <span id="shareTypeLabel">Today Received</span>
                                <span id="shareTransactionAmount">0</span>
                            </div>
                        </div>
                        
                        <div class="share-current-balance" id="shareCurrentBalance">
                            0
                        </div>
                        
                        <div id="shareComment" class="share-comment" style="display: none;">
                            <strong>Remark:</strong><br>
                            <span id="shareCommentText">No remarks</span>
                        </div>
                        
                        <div class="share-footer">
                            <small>Generated on: <span id="shareGeneratedDate"></span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadShareAsImage()">Save as Image</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Summary Share Modal -->
    <div class="modal fade" id="daySummaryModal" tabindex="-1">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Day Transaction Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="day-summary-card" id="daySummaryCard">
                        <div class="day-summary-header">
                            <div class="day-summary-member" id="daySummaryMember">Member Name</div>
                            <div class="day-summary-date" id="daySummaryDate">30/09/2024</div>
                        </div>
                        
                        <div class="day-summary-divider"></div>
                        
                        <div class="day-summary-row">
                            <span class="day-summary-label">Opening Balance</span>
                            <span class="day-summary-amount" id="daySummaryOpeningBalance">‚Çπ 1000</span>
                        </div>
                        
                        <div id="daySummaryTransactions">
                            <!-- Transactions will be added here dynamically -->
                        </div>
                        
                        <div class="day-summary-divider"></div>
                        
                        <div class="day-summary-current-balance" id="daySummaryCurrentBalance">
                            ‚Çπ 800
                        </div>
                        
                        <div class="day-summary-footer">
                            <small>Generated on: <span id="daySummaryGeneratedDate"></span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadDaySummaryAsImage()">Save as Image</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATED: Bill Links Modal - Side by Side Images -->
    <div class="modal fade bill-links-modal" id="billLinksModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bill Attachments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="bill-links-grid" id="billLinksModalContent">
                        <!-- Bill links will be added here as side by side images -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadAllBillLinks()">Download All Links</button>
                    <button type="button" class="btn btn-success" onclick="copyAllBillLinks()">Copy All Links</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup System Modal -->
    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üíæ Data Backup & Export</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Backup Status -->
                    <div class="backup-status-card">
                        <h6>üìä Current Data Status</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Members</small>
                                <div class="fw-bold" id="backupMemberCount">0</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Transactions</small>
                                <div class="fw-bold" id="backupTransactionCount">0</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Last Backup</small>
                                <div class="fw-bold" id="lastBackupDate">Never</div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Options -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="backup-option-card" onclick="exportToJSON()">
                                <div class="backup-icon">üìÑ</div>
                                <div class="backup-option-title">Export to JSON</div>
                                <div class="backup-option-desc">Complete data backup in JSON format</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="backup-option-card" onclick="exportToCSV()">
                                <div class="backup-icon">üìä</div>
                                <div class="backup-option-title">Export to CSV</div>
                                <div class="backup-option-desc">Excel-compatible spreadsheet format</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="backup-option-card" onclick="document.getElementById('importFile').click()">
                                <div class="backup-icon">üì•</div>
                                <div class="backup-option-title">Import Backup</div>
                                <div class="backup-option-desc">Restore data from saved files</div>
                            </div>
                            <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="importBackup(this.files[0])">
                        </div>
                    </div>

                    <!-- Data Protection Notice -->
                    <div class="alert alert-info mt-3">
                        <h6>üõ°Ô∏è Data Protection</h6>
                        <ul class="mb-0">
                            <li>No Data Loss - Browser clearing won't affect backups</li>
                            <li>Cross-Device - Save files to Google Drive, USB, computer</li>
                            <li>Regular Backups - Download backups periodically</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data Management
        let parties = JSON.parse(localStorage.getItem('parties')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentParty = null;
        let editingTransaction = null;
        let currentFilter = {
            fromDate: null,
            toDate: null,
            searchKeyword: null
        };

        // Number formatting function
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadMembers();
            document.getElementById('transactionDate').valueAsDate = new Date();
            updateBackupStatus();
            
            // Add event listener for Enter key in search
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applySearchFilter();
                }
            });

            // Add event listener for Enter key in bill link input
            document.getElementById('newBillLinkInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBillLinkFromInput();
                }
            });
        });

        // FIX: Function to close transaction modal properly
        function closeTransactionModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
            if (modal) {
                modal.hide();
            }
            // Reset scroll position
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
        }

        // View Management
        function showMemberList() {
            document.getElementById('memberListView').style.display = 'block';
            document.getElementById('memberDetailView').style.display = 'none';
            document.getElementById('backButton').style.display = 'none';
            document.getElementById('headerTitle').textContent = 'Partnership Business';
            currentParty = null;
            currentFilter.fromDate = null;
            currentFilter.toDate = null;
            currentFilter.searchKeyword = null;
            document.getElementById('searchKeyword').value = '';
        }

        function showMemberDetail(party) {
            currentParty = party;
            document.getElementById('memberListView').style.display = 'none';
            document.getElementById('memberDetailView').style.display = 'block';
            document.getElementById('backButton').style.display = 'block';
            document.getElementById('headerTitle').textContent = party.name;
            
            // Clear any existing filters when showing member details
            currentFilter.fromDate = null;
            currentFilter.toDate = null;
            currentFilter.searchKeyword = null;
            document.getElementById('filterSummary').style.display = 'none';
            document.getElementById('searchKeyword').value = '';
            
            updateMemberDetail();
            loadMemberTransactions();
        }

        // Date Range Filter Functions
        function toggleDateFilter() {
            const filterSection = document.getElementById('dateFilterSection');
            if (filterSection.style.display === 'none') {
                filterSection.style.display = 'block';
            } else {
                filterSection.style.display = 'none';
            }
        }

        // Search Filter Functions
        function applySearchFilter() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            currentFilter.searchKeyword = keyword ? keyword : null;
            updateMemberDetail();
            loadMemberTransactions();
        }

        function clearSearchFilter() {
            document.getElementById('searchKeyword').value = '';
            currentFilter.searchKeyword = null;
            updateMemberDetail();
            loadMemberTransactions();
        }

        // Quick Filter Functions
        function applyQuickFilter(type) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            
            switch(type) {
                case 'today':
                    fromDate = new Date(today);
                    toDate = new Date(today);
                    break;
                case 'yesterday':
                    fromDate = new Date(today);
                    fromDate.setDate(today.getDate() - 1);
                    toDate = new Date(fromDate);
                    break;
                case 'thisMonth':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = new Date(today);
                    break;
                case 'threeMonths':
                    fromDate = new Date(today);
                    fromDate.setMonth(today.getMonth() - 3);
                    toDate = new Date(today);
                    break;
                case 'oneYear':
                    fromDate = new Date(today);
                    fromDate.setFullYear(today.getFullYear() - 1);
                    toDate = new Date(today);
                    break;
            }
            
            // Format dates as YYYY-MM-DD
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            currentFilter.fromDate = formatDate(fromDate);
            currentFilter.toDate = formatDate(toDate);
            
            // Update filter inputs
            document.getElementById('filterFromDate').value = currentFilter.fromDate;
            document.getElementById('filterToDate').value = currentFilter.toDate;
            
            // Show filter summary and hide filter section
            document.getElementById('filterSummary').style.display = 'block';
            document.getElementById('dateFilterSection').style.display = 'none';
            
            // Format display text for filter summary
            const fromDisplay = formatDateForDisplay(currentFilter.fromDate);
            const toDisplay = formatDateForDisplay(currentFilter.toDate);
            document.getElementById('filterRangeText').textContent = `${fromDisplay} to ${toDisplay}`;
            
            updateMemberDetail();
            loadMemberTransactions();
        }

        // Helper function to format date for display (DD/MM/YYYY)
        function formatDateForDisplay(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function applyDateFilter() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            
            if (fromDate && toDate) {
                if (new Date(fromDate) > new Date(toDate)) {
                    alert('From date cannot be greater than To date!');
                    return;
                }
                
                currentFilter.fromDate = fromDate;
                currentFilter.toDate = toDate;
                
                // Show filter summary and hide filter section
                document.getElementById('filterSummary').style.display = 'block';
                document.getElementById('dateFilterSection').style.display = 'none';
                
                // Format display text for filter summary
                const fromDisplay = formatDateForDisplay(fromDate);
                const toDisplay = formatDateForDisplay(toDate);
                document.getElementById('filterRangeText').textContent = `${fromDisplay} to ${toDisplay}`;
                
                updateMemberDetail();
                loadMemberTransactions();
            } else {
                alert('Please select both From and To dates!');
            }
        }

        function clearDateFilter() {
            document.getElementById('filterFromDate').value = '';
            document.getElementById('filterToDate').value = '';
            currentFilter.fromDate = null;
            currentFilter.toDate = null;
            
            // Hide filter summary
            document.getElementById('filterSummary').style.display = 'none';
            
            updateMemberDetail();
            loadMemberTransactions();
        }

        // Member Management
        function loadMembers() {
            const memberList = document.getElementById('memberList');
            
            calculateAllMemberBalances();

            if (parties.length === 0) {
                memberList.innerHTML = `
                    <div class="empty-state">
                        <div>üë•</div>
                        <p class="mb-0">No members added yet</p>
                        <small class="text-muted">Click "Add Member" to get started</small>
                    </div>
                `;
                return;
            }

            memberList.innerHTML = parties.map(party => `
                <div class="member-item">
                    <div class="member-name" onclick="showMemberDetail(${JSON.stringify(party).replace(/"/g, '&quot;')})">${party.name}</div>
                    <div class="member-balance ${party.balance >= 0 ? 'text-success' : 'text-danger'}">
                        ‚Çπ${formatNumber(party.balance || 0)}
                    </div>
                    <div class="member-actions">
                        <div class="dropdown">
                            <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">‚ãØ</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="renameMember(${party.id})">Rename</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteMember(${party.id})">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function calculateAllMemberBalances() {
            parties.forEach(party => {
                const partyTransactions = transactions.filter(t => t.party === party.name);
                
                // Sort transactions by date to calculate balance correctly
                partyTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let balance = 0;
                partyTransactions.forEach(transaction => {
                    if (transaction.type === 'cash_in') {
                        balance += transaction.amount;
                    } else {
                        balance -= transaction.amount;
                    }
                });
                
                party.balance = balance;
            });
            saveParties();
        }

        function showAddMemberForm() {
            const memberName = prompt('Enter member name:');
            if (memberName && memberName.trim()) {
                const newParty = {
                    id: Date.now(),
                    name: memberName.trim(),
                    createdDate: new Date().toLocaleDateString(),
                    balance: 0
                };
                parties.push(newParty);
                saveParties();
                loadMembers();
                updateBackupStatus();
            }
        }

        function renameMember(partyId) {
            const party = parties.find(p => p.id === partyId);
            if (!party) return;
            
            const newName = prompt('Enter new name:', party.name);
            if (newName && newName.trim()) {
                // Update party name in transactions as well
                transactions.forEach(transaction => {
                    if (transaction.party === party.name) {
                        transaction.party = newName.trim();
                    }
                });
                
                party.name = newName.trim();
                saveParties();
                saveTransactions();
                loadMembers();
                updateBackupStatus();
                
                if (currentParty && currentParty.id === partyId) {
                    currentParty.name = newName.trim();
                    document.getElementById('headerTitle').textContent = newName.trim();
                }
            }
        }

        function deleteMember(partyId) {
            const party = parties.find(p => p.id === partyId);
            if (!party) return;
            
            if (confirm(`Are you sure you want to delete "${party.name}"? All transactions will be deleted.`)) {
                // Delete all transactions for this member
                transactions = transactions.filter(t => t.party !== party.name);
                
                // Delete the member
                parties = parties.filter(p => p.id !== partyId);
                
                saveParties();
                saveTransactions();
                loadMembers();
                updateBackupStatus();
                
                if (currentParty && currentParty.id === partyId) {
                    showMemberList();
                }
                
                alert(`"${party.name}" has been deleted successfully!`);
            }
        }

        // Member Detail Management
        function updateMemberDetail() {
            if (!currentParty) return;
            
            // Get all transactions for this member
            let memberTransactions = transactions.filter(t => t.party === currentParty.name);
            
            // Apply date filter if set
            let filteredTransactions = [];
            if (currentFilter.fromDate && currentFilter.toDate) {
                filteredTransactions = memberTransactions.filter(t => 
                    t.date >= currentFilter.fromDate && t.date <= currentFilter.toDate
                );
            } else {
                // If no filter, show all transactions
                filteredTransactions = [...memberTransactions];
            }
            
            // Apply search filter if set
            if (currentFilter.searchKeyword) {
                const keyword = currentFilter.searchKeyword.toLowerCase();
                filteredTransactions = filteredTransactions.filter(t => 
                    t.comment?.toLowerCase().includes(keyword) ||
                    t.amount.toString().includes(keyword) ||
                    t.party.toLowerCase().includes(keyword) ||
                    (t.billLinks && t.billLinks.some(link => link.toLowerCase().includes(keyword))) ||
                    t.type.toLowerCase().includes(keyword)
                );
            }
            
            // Calculate opening balance (balance before the filter period)
            let openingBalance = 0;
            
            if (currentFilter.fromDate) {
                // Get all transactions before the filter start date
                const transactionsBeforeFilter = memberTransactions.filter(t => t.date < currentFilter.fromDate);
                
                // Calculate opening balance from transactions before filter
                transactionsBeforeFilter.forEach(transaction => {
                    if (transaction.type === 'cash_in') {
                        openingBalance += transaction.amount;
                    } else {
                        openingBalance -= transaction.amount;
                    }
                });
            } else {
                // If no filter, opening balance is 0 (starting balance)
                openingBalance = 0;
            }
            
            // Calculate totals from filtered transactions only
            const totalIn = filteredTransactions
                .filter(t => t.type === 'cash_in')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalOut = filteredTransactions
                .filter(t => t.type === 'cash_out')
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate current balance
            const currentBalance = openingBalance + totalIn - totalOut;

            // Update UI with formatted numbers
            document.getElementById('detailOpeningBalance').textContent = '‚Çπ' + formatNumber(openingBalance);
            document.getElementById('detailTotalIn').textContent = '‚Çπ' + formatNumber(totalIn);
            document.getElementById('detailTotalOut').textContent = '‚Çπ' + formatNumber(totalOut);
            document.getElementById('detailRemainingBalance').textContent = '‚Çπ' + formatNumber(currentBalance);
        }

        // Transaction Management - MODAL VERSION
        function showTransactionForm(type) {
            if (!currentParty) {
                alert('Please select a member first!');
                return;
            }
            
            editingTransaction = null;
            
            // Set modal title based on transaction type
            const modalTitle = document.getElementById('transactionModalTitle');
            modalTitle.textContent = `${type === 'cash_in' ? 'Cash In' : 'Cash Out'} - ${currentParty.name}`;
            
            // Set transaction type
            document.getElementById('transactionType').value = type;
            
            // Set button text
            document.getElementById('saveTransactionBtn').textContent = 'Save Transaction';
            
            // Reset form
            document.getElementById('transactionFormElement').reset();
            document.getElementById('transactionDate').valueAsDate = new Date();
            document.getElementById('editingTransactionId').value = '';
            
            // Clear bill links containers
            document.getElementById('imagePreviewsContainer').innerHTML = '';
            document.getElementById('billLinksContainer').innerHTML = '';
            document.getElementById('newBillLinkInput').value = '';
            
            // Show modal
            const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
            transactionModal.show();
        }

        // UPDATED: New function to add bill link from input field
        function addBillLinkFromInput() {
            const input = document.getElementById('newBillLinkInput');
            const url = input.value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            // Add the link to preview
            addBillLinkPreview(url);
            
            // Clear the input
            input.value = '';
        }

        // UPDATED: New function to add bill link preview (side by side layout)
        function addBillLinkPreview(url) {
            const previewsContainer = document.getElementById('imagePreviewsContainer');
            const linksContainer = document.getElementById('billLinksContainer');
            const previewId = 'preview_' + Date.now();
            const linkId = 'link_' + Date.now();
            
            // Create hidden input to store the actual link
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = linkId;
            hiddenInput.value = url;
            linksContainer.appendChild(hiddenInput);
            
            // Create preview item
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.id = previewId;
            previewItem.innerHTML = '<div class="preview-loading">Loading preview...</div>';
            
            previewsContainer.appendChild(previewItem);
            
            // Check if URL is an image and load preview
            checkImagePreview(url, previewId, linkId);
        }

        // UPDATED: Function to check if URL is an image and show preview
        function checkImagePreview(url, previewId, linkId) {
            const previewItem = document.getElementById(previewId);
            
            // Check if URL is likely an image
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            const isDirectImageUrl = imageExtensions.some(ext => url.toLowerCase().includes(ext));
            
            // Check for pCloud links
            const isPCloudLink = url.includes('pcloud.link') || url.includes('pcloud.com');
            
            if (isDirectImageUrl || isPCloudLink) {
                const img = new Image();
                img.onload = function() {
                    previewItem.innerHTML = `
                        <img src="${url}" class="image-preview" alt="Bill preview" onclick="window.open('${url}', '_blank')">
                        <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                    `;
                };
                img.onerror = function() {
                    if (isPCloudLink) {
                        previewItem.innerHTML = `
                            <div class="preview-error">
                                <small>pCloud link - click to view</small>
                                <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                            </div>
                        `;
                    } else {
                        previewItem.innerHTML = `
                            <div class="preview-error">
                                <small>Cannot load preview</small>
                                <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                            </div>
                        `;
                    }
                };
                
                // Try to load the image
                img.src = url;
                
                // Set timeout in case image takes too long to load
                setTimeout(() => {
                    if (previewItem.innerHTML.includes('Loading preview')) {
                        if (isPCloudLink) {
                            previewItem.innerHTML = `
                                <div class="preview-error">
                                    <small>pCloud link - click to view</small>
                                    <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                                </div>
                            `;
                        } else {
                            previewItem.innerHTML = `
                                <div class="preview-error">
                                    <small>Preview timeout</small>
                                    <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                                </div>
                            `;
                        }
                    }
                }, 5000);
            } else {
                // Not an image URL
                previewItem.innerHTML = `
                    <div class="preview-error">
                        <small>Not an image URL</small>
                        <button type="button" class="remove-preview" onclick="removeBillLinkPreview('${previewId}', '${linkId}')">√ó</button>
                    </div>
                `;
            }
        }

        // UPDATED: Function to remove bill link preview
        function removeBillLinkPreview(previewId, linkId) {
            const previewItem = document.getElementById(previewId);
            const linkInput = document.getElementById(linkId);
            
            if (previewItem) previewItem.remove();
            if (linkInput) linkInput.remove();
        }

        // UPDATED: Function to get bill links from hidden inputs
        function getBillLinksFromForm() {
            const inputs = document.querySelectorAll('#billLinksContainer input');
            const links = [];
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    links.push(input.value.trim());
                }
            });
            
            return links;
        }

        // UPDATED: Function to set bill links in form (for editing)
        function setBillLinksInForm(links) {
            if (!links || links.length === 0) return;
            
            // Clear existing previews
            document.getElementById('imagePreviewsContainer').innerHTML = '';
            document.getElementById('billLinksContainer').innerHTML = '';
            
            // Add each link as a preview
            links.forEach(link => {
                addBillLinkPreview(link);
            });
        }

        // UPDATED: Bill Links Modal - Show images side by side without URLs
        function showBillLinksModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const modalContent = document.getElementById('billLinksModalContent');
            modalContent.innerHTML = '';
            
            if (!transaction.billLinks || transaction.billLinks.length === 0) {
                modalContent.innerHTML = '<p class="text-center text-muted">No bill attachments available</p>';
            } else {
                transaction.billLinks.forEach((link, index) => {
                    // Check if the link is an image
                    const isImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(link) || 
                                    link.includes('imgur') || 
                                    link.includes('images') ||
                                    link.includes('photos');
                    
                    const isPCloud = link.includes('pcloud.link') || link.includes('pcloud.com');
                    
                    const gridItem = document.createElement('div');
                    gridItem.className = 'bill-link-grid-item';
                    
                    if (isImage || isPCloud) {
                        // For image and pCloud links, show image preview
                        const img = document.createElement('img');
                        img.className = 'bill-link-grid-image';
                        img.src = isPCloud ? 'https://www.pcloud.com/favicon.ico' : link;
                        img.alt = `Bill ${index + 1}`;
                        img.style.objectFit = isPCloud ? 'contain' : 'cover';
                        img.style.backgroundColor = isPCloud ? 'white' : 'transparent';
                        img.onclick = () => window.open(link, '_blank');
                        
                        gridItem.appendChild(img);
                        
                        const info = document.createElement('div');
                        info.className = 'bill-link-grid-info';
                        info.textContent = `Bill ${index + 1}${isPCloud ? ' (pCloud)' : ''}`;
                        gridItem.appendChild(info);
                    } else {
                        // For non-image links, show placeholder
                        const placeholder = document.createElement('div');
                        placeholder.className = 'bill-link-grid-placeholder';
                        placeholder.innerHTML = 'üîó<br><small>Link</small>';
                        placeholder.onclick = () => window.open(link, '_blank');
                        
                        gridItem.appendChild(placeholder);
                        
                        const info = document.createElement('div');
                        info.className = 'bill-link-grid-info';
                        info.textContent = `Bill ${index + 1}`;
                        gridItem.appendChild(info);
                    }
                    
                    modalContent.appendChild(gridItem);
                });
            }
            
            // Store current transaction ID for download/copy functions
            modalContent.setAttribute('data-transaction-id', transactionId);
            
            const modal = new bootstrap.Modal(document.getElementById('billLinksModal'));
            modal.show();
        }

        function downloadAllBillLinks() {
            const modalContent = document.getElementById('billLinksModalContent');
            const transactionId = modalContent.getAttribute('data-transaction-id');
            const transaction = transactions.find(t => t.id == transactionId);
            
            if (!transaction || !transaction.billLinks || transaction.billLinks.length === 0) {
                alert('No bill links to download');
                return;
            }
            
            const content = transaction.billLinks.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bill-links-${transactionId}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function copyAllBillLinks() {
            const modalContent = document.getElementById('billLinksModalContent');
            const transactionId = modalContent.getAttribute('data-transaction-id');
            const transaction = transactions.find(t => t.id == transactionId);
            
            if (!transaction || !transaction.billLinks || transaction.billLinks.length === 0) {
                alert('No bill links to copy');
                return;
            }
            
            const content = transaction.billLinks.join('\n');
            
            navigator.clipboard.writeText(content).then(() => {
                alert('Bill links copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy links to clipboard');
            });
        }

        // EDIT TRANSACTION FEATURE
        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            editingTransaction = transaction;
            
            // Store current scroll position
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            
            // Set modal title
            const modalTitle = document.getElementById('transactionModalTitle');
            modalTitle.textContent = `Edit Transaction - ${currentParty.name}`;
            
            // Set transaction type
            document.getElementById('transactionType').value = transaction.type;
            
            // Set button text
            document.getElementById('saveTransactionBtn').textContent = 'Update Transaction';
            
            // Pre-fill form with transaction data
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('comment').value = transaction.comment || '';
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('editingTransactionId').value = transaction.id;
            
            // Pre-fill bill links
            setBillLinksInForm(transaction.billLinks);
            
            // Show modal
            const transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
            transactionModal.show();
            
            // Restore scroll position after modal is shown
            setTimeout(() => {
                window.scrollTo(0, scrollPosition);
            }, 100);
        }

        // Save transaction function for modal
        function saveTransaction() {
            const amount = parseFloat(document.getElementById('amount').value);
            const comment = document.getElementById('comment').value;
            const date = document.getElementById('transactionDate').value;
            const type = document.getElementById('transactionType').value;
            const editingId = document.getElementById('editingTransactionId').value;
            const billLinks = getBillLinksFromForm();

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount!');
                return;
            }

            if (editingId) {
                // Update existing transaction
                updateTransaction(editingId, amount, comment, date, type, billLinks);
            } else {
                // Create new transaction
                const transaction = {
                    id: Date.now(),
                    amount: amount,
                    party: currentParty.name,
                    comment: comment,
                    date: date,
                    type: type,
                    billLinks: billLinks,
                    timestamp: new Date().toISOString()
                };

                saveTransactionData(transaction);
            }
            
            // Close modal
            closeTransactionModal();
        }

        // Renamed from saveTransaction to avoid conflict
        function saveTransactionData(transaction) {
            transactions.push(transaction);
            saveTransactions();
            loadMemberTransactions();
            updateMemberDetail();
            updateBackupStatus();
            
            // Update member balance
            updateMemberBalance(transaction.party, transaction.amount, transaction.type);
        }

        function updateTransaction(transactionId, newAmount, newComment, newDate, newType, newBillLinks) {
            const transactionIndex = transactions.findIndex(t => t.id == transactionId);
            if (transactionIndex === -1) return;
            
            const oldTransaction = transactions[transactionIndex];
            
            // Update transaction
            transactions[transactionIndex] = {
                ...oldTransaction,
                amount: newAmount,
                comment: newComment,
                date: newDate,
                type: newType,
                billLinks: newBillLinks
            };
            
            saveTransactions();
            loadMemberTransactions();
            updateMemberDetail();
            loadMembers(); // Update member list balances
            updateBackupStatus();
        }

        function updateMemberBalance(memberName, amount, type) {
            let party = parties.find(p => p.name === memberName);
            if (!party) return;
            
            if (type === 'cash_in') {
                party.balance += amount;
            } else {
                party.balance -= amount;
            }
            
            saveParties();
            loadMembers();
        }

        function deleteTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const transaction = transactions.find(t => t.id === transactionId);
                
                if (transaction && transaction.party) {
                    // Remove transaction effect from balance
                    if (transaction.type === 'cash_in') {
                        updateMemberBalance(transaction.party, -transaction.amount, 'cash_out');
                    } else {
                        updateMemberBalance(transaction.party, -transaction.amount, 'cash_in');
                    }
                }
                
                // Delete transaction
                transactions = transactions.filter(t => t.id !== transactionId);
                
                saveTransactions();
                loadMemberTransactions();
                updateMemberDetail();
                updateBackupStatus();
            }
        }

        // SHARE TRANSACTION FEATURE
        function shareTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Get all transactions for this party
            const partyTransactions = transactions.filter(t => t.party === transaction.party);
            
            // Sort by date and time
            partyTransactions.sort((a, b) => {
                const dateCompare = new Date(a.date) - new Date(b.date);
                if (dateCompare === 0) {
                    return a.id - b.id;
                }
                return dateCompare;
            });
            
            // Calculate opening balance (balance before this transaction)
            let openingBalance = 0;
            for (let t of partyTransactions) {
                if (t.id === transaction.id) break;
                
                if (t.type === 'cash_in') {
                    openingBalance += t.amount;
                } else {
                    openingBalance -= t.amount;
                }
            }
            
            // Calculate current balance (after this transaction)
            let currentBalance = openingBalance;
            if (transaction.type === 'cash_in') {
                currentBalance += transaction.amount;
            } else {
                currentBalance -= transaction.amount;
            }
            
            // Fill modal with data
            document.getElementById('sharePartyName').textContent = transaction.party;
            document.getElementById('shareDate').textContent = transaction.date;
            document.getElementById('shareOpeningBalance').textContent = '‚Çπ' + formatNumber(openingBalance);
            
            if (transaction.type === 'cash_in') {
                document.getElementById('shareAmount').textContent = '+‚Çπ' + formatNumber(transaction.amount);
                document.getElementById('shareAmount').className = 'share-amount text-success';
                document.getElementById('shareTypeLabel').textContent = 'Today Received';
                document.getElementById('shareTransactionAmount').textContent = '‚Çπ' + formatNumber(transaction.amount);
            } else {
                document.getElementById('shareAmount').textContent = '-‚Çπ' + formatNumber(transaction.amount);
                document.getElementById('shareAmount').className = 'share-amount text-danger';
                document.getElementById('shareTypeLabel').textContent = 'Today Paid';
                document.getElementById('shareTransactionAmount').textContent = '‚Çπ' + formatNumber(transaction.amount);
            }
            
            document.getElementById('shareCurrentBalance').textContent = '‚Çπ' + formatNumber(currentBalance);
            
            // Show comment if exists
            if (transaction.comment && transaction.comment.trim() !== '') {
                document.getElementById('shareCommentText').textContent = transaction.comment;
                document.getElementById('shareComment').style.display = 'block';
            } else {
                document.getElementById('shareComment').style.display = 'none';
            }
            
            document.getElementById('shareGeneratedDate').textContent = new Date().toLocaleDateString();
            
            // Show modal
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
        }

        // DAY SUMMARY SHARE FEATURE
        function shareDaySummary(date) {
            if (!currentParty) return;
            
            // Get all transactions for this party on the specific date
            const dayTransactions = transactions.filter(t => 
                t.party === currentParty.name && t.date === date
            );
            
            if (dayTransactions.length === 0) {
                alert('No transactions found for this date!');
                return;
            }
            
            // Get all transactions for this party before the selected date
            const transactionsBeforeDate = transactions.filter(t => 
                t.party === currentParty.name && t.date < date
            );
            
            // Calculate opening balance (balance before this date)
            let openingBalance = 0;
            transactionsBeforeDate.forEach(transaction => {
                if (transaction.type === 'cash_in') {
                    openingBalance += transaction.amount;
                } else {
                    openingBalance -= transaction.amount;
                }
            });
            
            // Calculate total cash in and cash out for the day
            let totalIn = 0;
            let totalOut = 0;
            
            dayTransactions.forEach(transaction => {
                if (transaction.type === 'cash_in') {
                    totalIn += transaction.amount;
                } else {
                    totalOut += transaction.amount;
                }
            });
            
            // Calculate current balance (after all transactions of the day)
            const currentBalance = openingBalance + totalIn - totalOut;
            
            // Fill modal with data
            document.getElementById('daySummaryMember').textContent = currentParty.name;
            document.getElementById('daySummaryDate').textContent = formatDateForDisplay(date);
            document.getElementById('daySummaryOpeningBalance').textContent = '‚Çπ ' + formatNumber(openingBalance);
            document.getElementById('daySummaryCurrentBalance').textContent = '‚Çπ ' + formatNumber(currentBalance);
            
            // Add transactions to the summary
            const transactionsContainer = document.getElementById('daySummaryTransactions');
            transactionsContainer.innerHTML = '';
            
            dayTransactions.forEach(transaction => {
                const transactionRow = document.createElement('div');
                transactionRow.className = 'day-summary-row';
                
                const label = document.createElement('span');
                label.className = 'day-summary-label';
                label.textContent = transaction.comment || (transaction.type === 'cash_in' ? 'Today Received' : 'Cash Out');
                
                const amount = document.createElement('span');
                amount.className = `day-summary-amount ${transaction.type === 'cash_in' ? 'day-summary-positive' : 'day-summary-negative'}`;
                amount.textContent = `${transaction.type === 'cash_in' ? '+' : '-'} ‚Çπ ${formatNumber(transaction.amount)}`;
                
                transactionRow.appendChild(label);
                transactionRow.appendChild(amount);
                transactionsContainer.appendChild(transactionRow);
            });
            
            document.getElementById('daySummaryGeneratedDate').textContent = new Date().toLocaleDateString();
            
            // Show modal
            const daySummaryModal = new bootstrap.Modal(document.getElementById('daySummaryModal'));
            daySummaryModal.show();
        }

        // IMAGE DOWNLOAD FUNCTIONS
        function downloadShareAsImage() {
            const element = document.querySelector('#shareModal .share-card');
            downloadElementAsImage(element, 'transaction-receipt.png');
        }

        function downloadDaySummaryAsImage() {
            const element = document.getElementById('daySummaryCard');
            downloadElementAsImage(element, 'day-summary.png');
        }

        function downloadElementAsImage(element, filename) {
            html2canvas(element, {
                scale: 2, // Higher quality
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function loadMemberTransactions() {
            const transactionHistory = document.getElementById('transactionHistory');
            
            if (!currentParty) {
                transactionHistory.innerHTML = '<div class="empty-state">Select a member</div>';
                return;
            }

            let memberTransactions = transactions.filter(t => t.party === currentParty.name);

            // Apply date filter if set
            if (currentFilter.fromDate && currentFilter.toDate) {
                memberTransactions = memberTransactions.filter(t => 
                    t.date >= currentFilter.fromDate && t.date <= currentFilter.toDate
                );
            }
            
            // Apply search filter if set
            if (currentFilter.searchKeyword) {
                const keyword = currentFilter.searchKeyword.toLowerCase();
                memberTransactions = memberTransactions.filter(t => 
                    t.comment?.toLowerCase().includes(keyword) ||
                    t.amount.toString().includes(keyword) ||
                    t.party.toLowerCase().includes(keyword) ||
                    (t.billLinks && t.billLinks.some(link => link.toLowerCase().includes(keyword))) ||
                    t.type.toLowerCase().includes(keyword)
                );
            }

            if (memberTransactions.length === 0) {
                transactionHistory.innerHTML = `
                    <div class="empty-state">
                        <div>üí∏</div>
                        <p class="mb-0">No transactions found</p>
                        <small class="text-muted">${currentFilter.fromDate || currentFilter.searchKeyword ? 'Try changing the filter' : 'Add transactions using Cash In or Cash Out'}</small>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            memberTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Group by date
            const transactionsByDate = {};
            memberTransactions.forEach(transaction => {
                if (!transactionsByDate[transaction.date]) {
                    transactionsByDate[transaction.date] = [];
                }
                transactionsByDate[transaction.date].push(transaction);
            });

            // Display by date groups
            let html = '';
            Object.keys(transactionsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                html += `
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <strong>${formatDate(date)}</strong>
                        <button class="date-share-button" onclick="shareDaySummary('${date}')">üì§ Share Day</button>
                    </div>
                `;
                
                transactionsByDate[date].forEach(transaction => {
                    const hasBillLinks = transaction.billLinks && transaction.billLinks.length > 0;
                    const billLinksCount = hasBillLinks ? transaction.billLinks.length : 0;
                    
                    html += `
                        <div class="transaction-item ${transaction.type === 'cash_in' ? '' : 'cash-out'}">
                            <div class="transaction-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">‚ãØ</button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editTransaction(${transaction.id})">Edit</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="shareTransaction(${transaction.id})">Share</a></li>
                                        ${hasBillLinks ? `<li><a class="dropdown-item" href="#" onclick="showBillLinksModal(${transaction.id})">View Bills (${billLinksCount})</a></li>` : ''}
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteTransaction(${transaction.id})">Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="mb-1">${transaction.comment || 'No remark'}</div>
                                    <small class="text-muted">${transaction.date}</small>
                                    ${hasBillLinks ? `
                                        <div class="transaction-links-container">
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="showBillLinksModal(${transaction.id})">
                                                üìé Bills <span class="bill-link-count">${billLinksCount}</span>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-end">
                                    <div class="${transaction.type === 'cash_in' ? 'text-success' : 'text-danger'} fw-bold fs-5">
                                        ${transaction.type === 'cash_in' ? '+' : '-'}‚Çπ${formatNumber(transaction.amount)}
                                    </div>
                                    <small class="text-muted">${transaction.type === 'cash_in' ? 'Cash In' : 'Cash Out'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            transactionHistory.innerHTML = html;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        // PDF Download Functions
        function downloadPDF() {
            generatePDF(false);
        }

        function downloadFilteredPDF() {
            generatePDF(true);
        }

        function generatePDF(useFilter) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(0, 0, 128);
            doc.text('BUSINESS REPORT', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 25, { align: 'center' });
            
            if (currentParty) {
                doc.text(`Member: ${currentParty.name}`, 105, 32, { align: 'center' });
                
                // Get all transactions for this member
                let memberTransactions = transactions.filter(t => t.party === currentParty.name);
                
                // Apply date filter if requested
                if (useFilter && currentFilter.fromDate && currentFilter.toDate) {
                    memberTransactions = memberTransactions.filter(t => 
                        t.date >= currentFilter.fromDate && t.date <= currentFilter.toDate
                    );
                    
                    // Add filter info
                    doc.text(`Date Range: ${formatDateForDisplay(currentFilter.fromDate)} to ${formatDateForDisplay(currentFilter.toDate)}`, 105, 39, { align: 'center' });
                }
                
                // Apply search filter if requested
                if (useFilter && currentFilter.searchKeyword) {
                    const keyword = currentFilter.searchKeyword.toLowerCase();
                    memberTransactions = memberTransactions.filter(t => 
                        t.comment?.toLowerCase().includes(keyword) ||
                        t.amount.toString().includes(keyword) ||
                        t.party.toLowerCase().includes(keyword) ||
                        (t.billLinks && t.billLinks.some(link => link.toLowerCase().includes(keyword))) ||
                        t.type.toLowerCase().includes(keyword)
                    );
                    
                    // Add search info
                    doc.text(`Search: "${currentFilter.searchKeyword}"`, 105, 46, { align: 'center' });
                }
                
                // Calculate summary data
                let openingBalance = 0;
                let totalIn = 0;
                let totalOut = 0;
                
                if (useFilter && currentFilter.fromDate) {
                    // Calculate opening balance (transactions before filter)
                    const transactionsBeforeFilter = transactions.filter(t => 
                        t.party === currentParty.name && t.date < currentFilter.fromDate
                    );
                    
                    transactionsBeforeFilter.forEach(transaction => {
                        if (transaction.type === 'cash_in') {
                            openingBalance += transaction.amount;
                        } else {
                            openingBalance -= transaction.amount;
                        }
                    });
                }
                
                // Calculate totals from filtered transactions
                memberTransactions.forEach(transaction => {
                    if (transaction.type === 'cash_in') {
                        totalIn += transaction.amount;
                    } else {
                        totalOut += transaction.amount;
                    }
                });
                
                const finalBalance = openingBalance + totalIn - totalOut;
                
                // Add summary table
                const summaryData = [
                    ['Opening Balance', '‚Çπ ' + formatNumber(openingBalance)],
                    ['Cash In', '‚Çπ ' + formatNumber(totalIn)],
                    ['Cash Out', '‚Çπ ' + formatNumber(totalOut)],
                    ['Final Balance', '‚Çπ ' + formatNumber(finalBalance)]
                ];
                
                // Add summary title
                doc.setFontSize(16);
                let startY = 50;
                if (useFilter && (currentFilter.fromDate || currentFilter.searchKeyword)) {
                    startY = 55;
                    if (currentFilter.fromDate && currentFilter.searchKeyword) {
                        startY = 60;
                    }
                }
                doc.text('Summary', 14, startY);
                
                // Add summary table
                doc.autoTable({
                    startY: startY + 5,
                    body: summaryData,
                    theme: 'grid',
                    styles: { 
                        fontSize: 12, 
                        cellPadding: 5,
                        lineWidth: 0.5
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 60 },
                        1: { fontStyle: 'bold', cellWidth: 40 }
                    },
                    margin: { top: 10 }
                });
                
                // Sort transactions by date for table
                const sortedTransactions = [...memberTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let runningBalance = openingBalance;
                const tableData = sortedTransactions.map((transaction) => {
                    const openingBalanceForRow = runningBalance;
                    
                    if (transaction.type === 'cash_in') {
                        runningBalance += transaction.amount;
                    } else {
                        runningBalance -= transaction.amount;
                    }
                    
                    // Create bill links display
                    let billLinksDisplay = '-';
                    if (transaction.billLinks && transaction.billLinks.length > 0) {
                        billLinksDisplay = transaction.billLinks.length + ' bill' + (transaction.billLinks.length > 1 ? 's' : '');
                    }
                    
                    return [
                        transaction.date,
                        '‚Çπ ' + formatNumber(openingBalanceForRow),
                        transaction.type === 'cash_in' ? '‚Çπ ' + formatNumber(transaction.amount) : '-',
                        transaction.type === 'cash_out' ? '‚Çπ ' + formatNumber(transaction.amount) : '-',
                        '‚Çπ ' + formatNumber(runningBalance),
                        transaction.comment || '-',
                        billLinksDisplay
                    ];
                });
                
                // Add transaction table
                if (tableData.length > 0) {
                    doc.autoTable({
                        startY: doc.lastAutoTable.finalY + 10,
                        head: [['Date', 'Opening', 'Cash In', 'Cash Out', 'Balance', 'Remark', 'Bills']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [0, 123, 255],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        styles: { 
                            fontSize: 8, 
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 20 }, // Date
                            1: { cellWidth: 18 }, // Opening
                            2: { cellWidth: 15 }, // Cash In
                            3: { cellWidth: 15 }, // Cash Out
                            4: { cellWidth: 18 }, // Balance
                            5: { cellWidth: 45 }, // Remark
                            6: { cellWidth: 15 }  // Bills
                        },
                        pageBreak: 'auto'
                    });
                }
                
                // Add bill links with image indicators section after the table
                const transactionsWithBills = sortedTransactions.filter(t => t.billLinks && t.billLinks.length > 0);
                if (transactionsWithBills.length > 0) {
                    let yPosition = doc.lastAutoTable.finalY + 15;
                    
                    // Check if we need a new page
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 128);
                    doc.text('BILL ATTACHMENTS', 14, yPosition);
                    yPosition += 10;
                    
                    transactionsWithBills.forEach((transaction, index) => {
                        // Check if we need a new page
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        // Add separator line between transactions (except for first one)
                        if (index > 0) {
                            doc.setDrawColor(200, 200, 200);
                            doc.line(14, yPosition, 190, yPosition);
                            yPosition += 8;
                        }
                        
                        // Transaction header with date and full remark
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        
                        // Transaction info
                        const transactionInfo = `${transaction.date} - ${transaction.type.toUpperCase()} - ‚Çπ${formatNumber(transaction.amount)}`;
                        doc.text(transactionInfo, 14, yPosition);
                        yPosition += 5;
                        
                        // Remark
                        if (transaction.comment) {
                            doc.setFont(undefined, 'normal');
                            const remarkLines = doc.splitTextToSize(`Remark: ${transaction.comment}`, 180);
                            remarkLines.forEach(line => {
                                if (yPosition > 270) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                doc.text(line, 14, yPosition);
                                yPosition += 4;
                            });
                        }
                        
                        yPosition += 3;
                        
                        // Bill links with image indicators
                        doc.setFontSize(9);
                        transaction.billLinks.forEach((link, linkIndex) => {
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            
                            // Check if link is an image or pCloud
                            const isImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(link) || 
                                          link.includes('imgur') || 
                                          link.includes('images') ||
                                          link.includes('photos');
                            
                            const isPCloud = link.includes('pcloud.link') || link.includes('pcloud.com');
                            
                            const linkText = `Bill ${linkIndex + 1}${isImage ? ' üì∑' : ''}${isPCloud ? ' ‚òÅÔ∏è' : ''}`;
                            
                            // Make the link text clickable
                            doc.setTextColor(0, 0, 255);
                            doc.textWithLink(linkText, 20, yPosition, { url: link });
                            
                            // Show the actual URL in black (non-clickable)
                            doc.setTextColor(0, 0, 0);
                            const urlText = `: ${link}`;
                            doc.text(urlText, 20 + doc.getTextWidth(linkText), yPosition);
                            
                            yPosition += 4;
                        });
                        
                        // Add space after each transaction
                        yPosition += 8;
                    });
                }
            } else {
                // All members summary
                const memberData = parties.map(party => [
                    party.name,
                    '‚Çπ' + formatNumber(party.balance || 0)
                ]);
                
                doc.autoTable({
                    startY: 40,
                    head: [['Member', 'Balance']],
                    body: memberData,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 123, 255],
                        textColor: 255,
                        fontStyle: 'bold'
                    }
                });
            }
            
            let fileName = currentParty ? `${currentParty.name}-report.pdf` : 'members-report.pdf';
            
            if (useFilter && currentFilter.fromDate && currentFilter.toDate) {
                fileName = `${currentParty.name}-${currentFilter.fromDate}-to-${currentFilter.toDate}.pdf`;
            }
            
            doc.save(fileName);
        }

        // BACKUP SYSTEM FUNCTIONS
        function updateBackupStatus() {
            document.getElementById('backupMemberCount').textContent = parties.length;
            document.getElementById('backupTransactionCount').textContent = transactions.length;
            
            const lastBackup = localStorage.getItem('lastBackup');
            if (lastBackup) {
                document.getElementById('lastBackupDate').textContent = new Date(parseInt(lastBackup)).toLocaleString();
            } else {
                document.getElementById('lastBackupDate').textContent = 'Never';
            }
        }

        function exportToJSON() {
            const backupData = {
                parties: parties,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.1' // Updated version to include bill links
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `business-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            // Update last backup time
            localStorage.setItem('lastBackup', Date.now().toString());
            updateBackupStatus();
            
            showBackupSuccess('JSON backup created successfully!');
        }

        function exportToCSV() {
            // Create CSV content for transactions
            let csvContent = 'Date,Member,Type,Amount,Remark,BillLinks\n';
            
            transactions.forEach(transaction => {
                const billLinksStr = transaction.billLinks ? transaction.billLinks.join('; ') : '';
                const row = [
                    transaction.date,
                    `"${transaction.party}"`,
                    transaction.type,
                    transaction.amount,
                    `"${transaction.comment || ''}"`,
                    `"${billLinksStr}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const dataBlob = new Blob([csvContent], {type: 'text/csv'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            // Update last backup time
            localStorage.setItem('lastBackup', Date.now().toString());
            updateBackupStatus();
            
            showBackupSuccess('CSV backup created successfully!');
        }

        function importBackup(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedParties = [];
                    let importedTransactions = [];
                    
                    if (file.name.endsWith('.json')) {
                        // JSON import
                        const backupData = JSON.parse(content);
                        
                        if (backupData.parties && backupData.transactions) {
                            importedParties = backupData.parties;
                            importedTransactions = backupData.transactions;
                        } else {
                            throw new Error('Invalid backup file format');
                        }
                    } else if (file.name.endsWith('.csv')) {
                        // CSV import (transactions only)
                        importedParties = [...parties]; // Keep existing members
                        importedTransactions = parseCSV(content);
                    } else {
                        throw new Error('Unsupported file format');
                    }
                    
                    if (confirm(`This will replace all current data with ${importedParties.length} members and ${importedTransactions.length} transactions. Continue?`)) {
                        // Replace data
                        parties = importedParties;
                        transactions = importedTransactions;
                        
                        // Save to localStorage
                        saveParties();
                        saveTransactions();
                        
                        // Update UI
                        loadMembers();
                        updateBackupStatus();
                        
                        if (currentParty) {
                            updateMemberDetail();
                            loadMemberTransactions();
                        }
                        
                        showBackupSuccess('Data imported successfully!');
                        
                        // Close modal
                        const backupModal = bootstrap.Modal.getInstance(document.getElementById('backupModal'));
                        backupModal.hide();
                    }
                } catch (error) {
                    alert('Error importing backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const transactions = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Simple CSV parsing (doesn't handle commas in quotes perfectly)
                const parts = line.split(',');
                if (parts.length < 4) continue;
                
                const date = parts[0];
                const party = parts[1].replace(/"/g, '');
                const type = parts[2];
                const amount = parseFloat(parts[3]);
                const comment = parts[4] ? parts[4].replace(/"/g, '') : '';
                const billLinksStr = parts[5] ? parts[5].replace(/"/g, '') : '';
                const billLinks = billLinksStr ? billLinksStr.split('; ').filter(link => link.trim() !== '') : [];
                
                if (date && party && type && !isNaN(amount)) {
                    transactions.push({
                        id: Date.now() + i, // Simple ID generation
                        date: date,
                        party: party,
                        type: type,
                        amount: amount,
                        comment: comment,
                        billLinks: billLinks,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            return transactions;
        }

        function showBackupSuccess(message) {
            // Create success alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success backup-success-alert';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2">‚úÖ</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Remove after animation
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Local Storage
        function saveParties() {
            localStorage.setItem('parties', JSON.stringify(parties));
        }

        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // Back button event
        document.getElementById('backButton').addEventListener('click', showMemberList);

        // Add Enter key support in transaction modal
        document.getElementById('transactionFormElement').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveTransaction();
            }
        });
    </script>
</body>
</html>