<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Invoice</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* ======================= CSS ======================= */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
body { background: #e0e5ec; padding: 10px; }
.container {
  background: #fff; 
  border-radius: 12px; 
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  width: 100%; 
  max-width: 760px; 
  padding: 20px;
  position: relative;
}

.header { 
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px; 
}
.header input {
  border: none; 
  font-size: 24px; 
  font-weight: 700; 
  text-align: center;
  width: 100%; 
  border-bottom: 3px solid #ddd; 
  padding: 8px; 
  outline: none;
  border-radius: 6px; 
  background: #f8f8f8;
  flex: 1;
}

/* ======= Date and Count =======*/
#simplified-info {
  display: flex;
  justify-content: flex-start;
  gap: 20px;
  width: 100%; 
}
#simplified-info div {
  font-size: 14px;
  font-weight: 600;
  color: #222;
  text-align: left;
  flex: 0 0 auto;  
} 

/* Modern table */
.products-table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0 8px; 
  margin-bottom: 15px; 
}
.products-table th, .products-table td {
  padding: 10px 8px; font-size: 15px; text-align: left;
}
.products-table th { background: #f1f3f6; color: #555; font-weight: 600; }
.products-table td { background: #f9f9f9; border-radius: 8px; vertical-align: middle; }
.product-search { 
  width: 100%; 
  padding: 10px; 
  border: 1px solid #ccc; 
  border-radius: 8px; 
}   
  
.quantity-input {
  width: 60px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  text-align: center;
  font-weight: 700;  
  font-size: 15px;
  background-color: #f8d7da;
  color: #721c24;
  transition: background 0.3s, color 0.3s;
}
.quantity-input:not(:placeholder-shown) {
  background-color: #fff;
  color: #000;
}
.mrp-display, .total-display { display: block; text-align: right; font-weight: 600; color: #222; }

/* ================= BUTTON LAYOUT ================= */
.action-buttons { 
  display: flex; 
  justify-content: space-between; 
  gap: 15px; 
  margin-bottom: 15px;
  width: 100%;
}

.action-buttons .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.bottom-buttons {
  display: flex;
  justify-content: space-between;
  gap: 15px;
  margin-top: 10px;
  width: 100%;
}

.bottom-buttons .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.btn { 
  padding: 8px 16px; 
  font-size: 14px; 
  font-weight: 600; 
  border: none; 
  border-radius: 6px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 5px; 
  transition: all 0.3s;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.btn-clear { background: #ff6b6b; color: #fff; }
.btn-add { background: #1dd1a1; color: #fff; }
.btn-save { background: #1976d2; color: #fff; }
.btn-history { background: #ff9800; color: #fff; }
.btn-sync { background: #9c27b0; color: #fff; }
.btn-export { background: #4caf50; color: #fff; }
.btn-import { background: #ff9800; color: #fff; }

/* Summary section */
.summary-section { margin-top: 10px; }
.summary-row { 
  display: flex; 
  justify-content: space-between; 
  padding: 8px 0; 
  font-size: 14px; 
  align-items: center;
}   
.summary-row span:last-child {
  font-weight: 700;  
  color: #000;
}
.summary-row.final-total span:last-child {
  font-weight: 700;
  color: #1976d2;
}
#subtotal, #discount-amount, #total-discount {
  font-size: 16px;
} 

.final-total { 
  border-top: 2px solid #ddd; 
  margin-top: 8px; 
  font-size: 16px; 
  font-weight: 700; 
  color: #1976d2; 
}
.discount-input { 
  width: 70px; 
  padding: 6px; 
  border: 1px solid #ddd; 
  border-radius: 6px; 
  text-align: center; 
  background: #fff; 
  color: #000; 
  font-weight: 600;
}

/* Divider */
.divider {
  height: 1px;
  background: #ddd;
  margin: 15px 0;
}

/* Responsive mobile */
@media (max-width: 600px) {
  .info-section { justify-content: center; }
  .action-buttons { flex-direction: row; gap: 10px; }
  .action-buttons .btn { min-width: 100px; font-size: 13px; padding: 8px 12px; }
  .bottom-buttons { flex-direction: row; gap: 10px; }
  .bottom-buttons .btn { min-width: 100px; font-size: 13px; padding: 8px 12px; }
  .products-table td { font-size: 14px; padding: 8px; }
  .product-search { padding: 8px; font-size: 14px; }
  .quantity-input { width: 50px; padding: 4px; }
  .header { flex-direction: column; gap: 10px; }
  .header input { font-size: 20px; }
}

@media (max-width: 400px) {
  .action-buttons .btn, .bottom-buttons .btn { 
    min-width: 90px; font-size: 12px; padding: 6px 10px; 
  }
}

.screenshot-btn {
  position: absolute; 
  top: 10px; 
  right: 10px;
  background: #1976d2; 
  color: #fff; 
  border: none; 
  padding: 8px 12px; 
  font-size: 14px; 
  font-weight: 600; 
  border-radius: 6px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 5px;
  transition: all 0.3s;
}
.screenshot-btn:hover { 
  background: #125aa0; 
  transform: translateY(-2px);
}

/* Status Messages */
.status-message {
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  text-align: center;
  font-weight: 600;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.status-info {
  background: #cce7ff;
  color: #004085;
  border: 1px solid #b3d7ff;
}

.status-warning {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

/* Modal Styles */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: none;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: #000;
}

.history-item {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  background: #f9f9f9;
}

.history-date {
  font-weight: bold;
  color: #1976d2;
  margin-bottom: 10px;
  font-size: 16px;
}

.history-products {
  margin: 10px 0;
}

.history-product {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
  font-size: 14px;
}

.history-totals {
  border-top: 1px solid #ddd;
  padding-top: 10px;
  margin-top: 10px;
}

.history-total-row {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

.final-amount {
  color: #1976d2;
  font-size: 16px;
}

.discount-message {
  font-size: 12px;
  color: #28a745;
  font-weight: 600;
  margin-top: 5px;
  text-align: center;
  display: none;
}

.sync-status {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 1001;
}

.backup-section {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin: 10px 0;
  border: 1px solid #dee2e6;
}

.backup-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* ==== DROPDOWN PRODUCTS STYLE ===== */
.backup-buttons .btn {
  flex: 1;
  justify-content: center;
}
  /* ================= AUTCOMPLETE DROPDOWN STYLING ================= */
.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #1976d2;
    border-radius: 8px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.ui-menu .ui-menu-item {
    padding: 10px 10px;
    border-bottom: 2px solid #ddd;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.2s;
}

.ui-menu .ui-menu-item:last-child {
    border-bottom: none;
}

.ui-menu .ui-menu-item:hover {
    background: #e3f2fd;
    color: #1976d2;
    border-left: 3px solid #1976d2;
}

.ui-menu .ui-state-active, 
.ui-menu .ui-state-focus {
    background: #1976d2 !important;
    color: white !important;
    border: none !important;
    margin: 0 !important;
}

.ui-autocomplete .ui-menu-item-wrapper {
    padding: 8px 12px !important;
}

/* New History Management Styles */
.history-management {
  margin-top: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.history-management h4 {
  margin-bottom: 10px;
  color: #1976d2;
  display: flex;
  align-items: center;
  gap: 8px;
}

.history-actions {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.history-actions .btn {
  flex: 1;
  min-width: 140px;
  justify-content: center;
}

.delete-history-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  margin-left: 10px;
}

.delete-history-btn:hover {
  background: #c82333;
}

.history-item {
  position: relative;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  background: #f9f9f9;
}

.history-date {
  font-weight: bold;
  color: #1976d2;
  margin-bottom: 10px;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.history-products {
  margin: 10px 0;
}

.history-product {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
  font-size: 14px;
}

.history-totals {
  border-top: 1px solid #ddd;
  padding-top: 10px;
  margin-top: 10px;
}

.history-total-row {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

.final-amount {
  color: #1976d2;
  font-size: 16px;
}

.daily-report-section {
  margin-top: 20px;
  padding: 15px;
  background: #e8f4fd;
  border-radius: 8px;
  border: 1px solid #b3d7ff;
}

.daily-report-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.date-filter {
  display: flex;
  gap: 10px;
  align-items: center;
}

.date-filter input {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}

.daily-report-list {
  max-height: 400px;
  overflow-y: auto;
}

.patient-day-summary {
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin: 8px 0;
}

.patient-day-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid #eee;
}

.patient-day-name {
  font-weight: bold;
  color: #1976d2;
  font-size: 15px;
}

.patient-day-total {
  font-weight: bold;
  color: #28a745;
}

.no-history {
  text-align: center;
  color: #6c757d;
  font-style: italic;
  padding: 20px;
}

.confirm-delete {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 6px;
  padding: 10px;
  margin: 10px 0;
  text-align: center;
}

.confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

.confirm-buttons .btn {
  min-width: 80px;
}

/* Add Product Modal Styles */
.form-group {
  margin: 15px 0;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  color: #333;
}

#new-product-name, #new-product-mrp {
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 16px;
}

#new-product-name:focus, #new-product-mrp:focus {
  border-color: #1976d2;
  outline: none;
}
</style>
</head>
<body>
<div class="container" id="billing-container">
  <button class="screenshot-btn" id="screenshot-btn">
    <i class="fa fa-camera"></i> 
  </button>
  
  <div class="header">
    <input type="text" id="name" placeholder="PATIENT NAME" list="patient-list">
    <datalist id="patient-list"></datalist>
  </div>
  
  <!-- SIMPLIFIED DATE & TOTAL PRODUCTS -->
  <div class="info-section" id="simplified-info">
    <div id="date-display"></div>
  </div> 
  
  <table class="products-table">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>MRP ₹</th>
        <th>QTY</th>
        <th>Total ₹</th>
      </tr>
    </thead>
    <tbody id="products-body">
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    </tbody>
  </table>
  
  <!-- SIMPLIFIED DATE & TOTAL PRODUCTS -->
  <div class="info-section" id="simplified-info">
    <div id="total-products-display"></div>
  </div>
  
  <div class="action-buttons">
    <button class="btn btn-add" id="add-row"><i class="fa fa-plus"></i> Add Row</button>
    <button class="btn btn-add" id="add-product-btn"><i class="fa fa-capsules"></i> Add Product</button>
    <button class="btn btn-clear" id="clear-all"><i class="fa fa-trash"></i> Clear All</button>
</div>
  
  <div class="summary-section">
    <div class="summary-row"><span>Total All</span><span id="subtotal">₹0.00</span></div>
    
    <div class="summary-row">
      <span>Dis. %</span>
      <input type="number" class="discount-input" id="discount-percent" value="" min="0" max="100" placeholder="0">
      <span>Dis. Amt (₹)</span>
      <input type="number" class="discount-input" id="discount-flat" value="" min="0" placeholder="0">
    </div>
    
    <div class="summary-row">
      <span>Total Discount</span>
      <span id="total-discount">₹0.00</span>
    </div>
    
    <div class="summary-row final-total">
      <span>Final Total</span>
      <span id="final-total">₹0.00</span>
    </div>
    
    <div id="discount-message" class="discount-message"></div>
  </div>
  
  <div class="divider"></div>
  
  <div class="bottom-buttons">
    <button class="btn btn-save" id="save-btn"><i class="fa fa-save"></i> Save</button>
    <button class="btn btn-history" id="history-btn"><i class="fa fa-history"></i> History</button>
    <button class="btn btn-sync" id="backup-btn"><i class="fa fa-download"></i> Backup</button>
  </div>

  <div id="status-message"></div>
</div>

<!-- Patient History Modal -->
<div id="history-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Patient History - <span id="history-patient-name"></span></h3>
    <div id="history-list"></div>
  </div>
</div>

<!-- Backup Modal -->
<div id="backup-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3><i class="fa fa-download"></i> Data Backup & Restore</h3>
    
    <div class="backup-section">
      <h4><i class="fa fa-download"></i> Export Data</h4>
      <p>Download all patient data as a backup file:</p>
      <div class="backup-buttons">
        <button class="btn btn-export" id="export-json"><i class="fa fa-file-code"></i> Export JSON</button>
        <button class="btn btn-export" id="export-csv"><i class="fa fa-file-excel"></i> Export CSV</button>
      </div>
    </div>

    <div class="backup-section">
      <h4><i class="fa fa-upload"></i> Import Data</h4>
      <p>Restore patient data from backup file:</p>
      <div class="backup-buttons">
        <input type="file" id="import-file" accept=".json,.csv" style="display: none;">
        <button class="btn btn-import" id="import-btn"><i class="fa fa-upload"></i> Import Backup</button>
      </div>
    </div>

    <div class="backup-section">
      <h4><i class="fa fa-info-circle"></i> Backup Status</h4>
      <div id="backup-status" class="status-message status-info">
        Last Backup: <span id="last-backup-time">Never</span><br>
        Total Patients: <span id="backup-patient-count">0</span><br>
        Total Records: <span id="backup-record-count">0</span><br>
        Total Products: <span id="backup-product-count">0</span>
      </div>
    </div>

    <div class="backup-section status-warning">
      <h4><i class="fa fa-exclamation-triangle"></i> Important</h4>
      <p>Regularly backup your data to avoid loss. Browser data can be cleared automatically.</p>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="add-product-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <span class="close">&times;</span>
    <h3><i class="fa fa-plus"></i> Add New Product</h3>
    
    <div class="backup-section">
      <div class="form-group">
        <label>Product Name:</label>
        <input type="text" id="new-product-name" class="product-search" placeholder="Enter product name" style="width: 100%; padding: 10px; margin: 8px 0;">
      </div>
      
      <div class="form-group">
        <label>MRP (₹):</label>
        <input type="number" id="new-product-mrp" step="0.01" placeholder="Enter MRP" style="width: 100%; padding: 10px; margin: 8px 0;">
      </div>
      
      <div class="backup-buttons">
        <button class="btn btn-save" id="save-new-product">
          <i class="fa fa-save"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================= JS ======================= */
$(document).ready(function() {
  const DATA_PREFIX = "patient_history_";
  const PRODUCTS_STORAGE_KEY = "custom_products_list";

  // ================= DATE DISPLAY =================
  const today = new Date();
  const formattedDate = today.getFullYear() + "/" + 
                        String(today.getMonth() + 1).padStart(2, '0') + "/" + 
                        String(today.getDate()).padStart(2, '0');
  $('#date-display').text("Date: " + formattedDate);

  // ================= PRODUCT MANAGEMENT =================
  let products = [];

  // Load products from localStorage or use default
  function loadProducts() {
      const savedProducts = localStorage.getItem(PRODUCTS_STORAGE_KEY);
      if (savedProducts) {
          return JSON.parse(savedProducts);
      } else {
          // Save default products to localStorage
          const defaultProducts = [
            { name: "1 ALL 5", mrp: 3.8 },
    { name: "ACERD", mrp: 1.50 },
    { name: "ACINIL O 120", mrp: 135.90 },
    { name: "ACINIL O 200", mrp: 201 },
    { name: "ACOFEROL 6L INJ", mrp: 59 },
    { name: "ACOLAN TR", mrp: 12 },
    { name: "AKURIT 3 TAB", mrp: 7.56 },
    { name: "AKURIT 4 TAB", mrp: 10 },
    { name: "ALKASOL", mrp: 143 },
    { name: "AMINOFIT", mrp: 26.73 },
    { name: "AMITAG 10MG TAB", mrp: 2.70 },
    { name: "AMITAG 25MG TAB", mrp: 3 },
    { name: "AMLOKIND 5MG TAB", mrp: 1.7 },
    { name: "AMLOKIND AT TAB", mrp: 4.50 },
    { name: "Amlovas 10", mrp: 2 },
    { name: "Amlovas 5", mrp: 3 },
    { name: "ANOPLUS TAB", mrp: 5 },
    { name: "ARGIPREG ST", mrp: 64.90 },
    { name: "Aristozyme Drops", mrp: 79.70 },
    { name: "Astymin C Drops", mrp: 99.50 },
    { name: "ATOWISH F TAB", mrp: 9 },
    { name: "AUGMENTIN 1G", mrp: 66.1 },
    { name: "AVIL 25", mrp: 0.80 },
    { name: "Axbex Susp 100ml", mrp: 98.38 },
    { name: "Axbex Susp 200ml", mrp: 175 },
    { name: "BACZIN 10MG", mrp: 13.50 },
    { name: "BANDAGE 4", mrp: 8 },
    { name: "BECOSULE", mrp: 3 },
    { name: "BECOSULE Z", mrp: 3 },
    { name: "BENADON 40", mrp: 3 },
    { name: "BENTILIDE TAB", mrp: 5 },
    { name: "BETNISOL", mrp: 1.13 },
    { name: "Bethadoxin 12", mrp: 101 },
    { name: "Bethadoxin P", mrp: 101 },
    { name: "BON NXT TAB", mrp: 23.50 },
    { name: "CALCIMAX D1000", mrp: 13 },
    { name: "CALWART K2 TAB", mrp: 18.50 },
    { name: "CEFJUST 500", mrp: 32 },
    { name: "CEFJUST 250", mrp: 16 },
    { name: "CEFZIM 200", mrp: 11 },
    { name: "CELIN 500", mrp: 2 },
    { name: "CeffKid 125mg", mrp: 11 },
    { name: "Chericof 12 Susp", mrp: 140 },
    { name: "Chericof 60ml", mrp: 140 },
    { name: "CIPLADINE 10G", mrp: 35 },
    { name: "CIPLAR 10", mrp: 1.50 },
    { name: "Clarigard 500", mrp: 35 },
    { name: "Clavcare 625", mrp: 18.50 },
    { name: "CLINTON TRIO", mrp: 154 },
    { name: "CO TRIMOXAZOLE", mrp: 2.50 },
    { name: "COMBIFLAM", mrp: 3 },
    { name: "COMBUTOL 1000", mrp: 17.50 },
    { name: "COMBUTOL 800", mrp: 5.20 },
    { name: "Colimex Drops", mrp: 97.80 },
    { name: "COMPLAMINA RET", mrp: 19.7 },
    { name: "CYPON SYP", mrp: 149 },
    { name: "Cynocal 16", mrp: 2.50 },
    { name: "Cynocal Plus", mrp: 3 },
    { name: "Cypon Drops", mrp: 61 },
    { name: "Cypon H 200ml", mrp: 215 },
    { name: "Cypon H Plus Drop", mrp: 89 },
    { name: "CYRA D", mrp: 5 },
    { name: "CYTLOC", mrp: 21 },
    { name: "DALACIN C 300", mrp: 30 },
    { name: "DECDAN B 4MG INJ", mrp: 5.50 },
    { name: "DEFCORT 6", mrp: 15 },
    { name: "Deplatt A 75", mrp: 2 },
    { name: "DOPLUS DT .", mrp: 8 },
    { name: "DOROCLINE 100", mrp: 3.50 },
    { name: "DOXY PLUS LB", mrp: 9 },
    { name: "DYTOR 20", mrp: 14.86 },
    { name: "DYTOR 10", mrp: 7 },
    { name: "DYTOR 5", mrp: 5.50 },
    { name: "ECOSPRIN 75", mrp: 0.40 },
    { name: "Ecosprin Av 150/20 ", mrp: 4.75 },
    { name: "Ecosprin Av 75", mrp: 4.33 },
    { name: "Esolembic D", mrp: 8 },
    { name: "ETOS 60", mrp: 5.50 },
    { name: "ETROBAX 90", mrp: 19.7 },
    { name: "Etrobax 60", mrp: 14.50 },
    { name: "Etizola Plus 5mg", mrp: 2 },
    { name: "EVION 400", mrp: 4.50 },
    { name: "EVION LC", mrp: 7 },
    { name: "FCN 150", mrp: 13 },
    { name: "Feboxa 40", mrp: 19 },
    { name: "Flexon Mr Tab", mrp: 3 },
    { name: "FOLITRAX 7.5 MTX", mrp: 16.50 },
    { name: "FOLVITE", mrp: 1.7 },
    { name: "Fusigin Cream", mrp: 54 },
    { name: "Fusiwal Cream", mrp: 54 },
    { name: "GABANEURON 300 ", mrp: 21.50 },
    { name: "GABANEURON SR 600", mrp: 41.90 },
    { name: "GESTASTAT 200", mrp: 30 },
    { name: "Glizid Total P 15", mrp: 12.90 },
    { name: "HAEM UP", mrp: 3.63 },
    { name: "HCG 5000", mrp: 458 },
    { name: "HCQS 200", mrp: 7.12 },
    { name: "HEALTH OK", mrp: 36 },
    { name: "HNORM RD", mrp: 5 },
    { name: "IMACIN SR 75 ", mrp: 16.70 },
    { name: "INDOMEG SR 75", mrp: 13 },
    { name: "Iprazest Respules", mrp: 2 },
    { name: "ISRIL M1 500", mrp: 3 },
    { name: "Isryl M1 Forte", mrp: 5.80 },
    { name: "Isryl M2", mrp: 4.50 },
    { name: "Isryl M2 Forte", mrp: 7.30 },
    { name: "KMet 500", mrp: 2.2 },
    { name: "KVog 0.2", mrp: 4.85 },
    { name: "LCIN 500", mrp: 10 },
    { name: "LCIN 750", mrp: 16 },
    { name: "Levomac 500", mrp: 10 },
    { name: "LEVOSIZ 10", mrp: 3.50 },
    { name: "Lexa 10", mrp: 8.47 },
    { name: "LIBOTRYP", mrp: 5.50 },
    { name: "Lincotus Dx", mrp: 125 },
    { name: "LIZOSPEY 600", mrp: 38 },
    { name: "Loxof 500", mrp: 10 },
    { name: "LUTIGEST 500", mrp: 260 },
    { name: "M2TONE", mrp: 152 },
    { name: "Macbate Susp", mrp: 158.39 },
    { name: "Macpod 100", mrp: 15.50 },
    { name: "Macpod 50", mrp: 9.50 },
    { name: "Mactor 10", mrp: 5.53 },
    { name: "Mactor 20", mrp: 11.25 },
    { name: "MAHAFLOX 400", mrp: 24.50 },
    { name: "MEDROTRIL", mrp: 6.90 },
    { name: "MEFTAL FORTE", mrp: 4.60 },
    { name: "Meftal Spas Drop", mrp: 52 },
    { name: "MELSONE 4", mrp: 4 },
    { name: "METROGIL 200", mrp: 0.90 },
    { name: "METROGIL 400", mrp: 1.75 },
    { name: "METHYGENE", mrp: 10 },
    { name: "Metomac 25", mrp: 3.64 },
    { name: "MIKACIN 100", mrp: 39.95 },
    { name: "MIKACIN 250", mrp: 61.30 },
    { name: "MIKACIN 500", mrp: 60 },
    { name: "MISOPROST 200", mrp: 21 },
    { name: "MITHCAL MOM", mrp: 155 },
    { name: "MOBIWIN D TAB", mrp: 19.50 },
    { name: "MOLIPRIDE 25", mrp: 4.50 },
    { name: "Monocan 200", mrp: 25 },
    { name: "MONOCEF 1G", mrp: 50 },
    { name: "MONOCEF 250", mrp: 31.74 },
    { name: "MONOCEF 500", mrp: 56.31 },
    { name: "Montemac Fx", mrp: 21 },
    { name: "MYLAMIN CAP", mrp: 7.50 },
    { name: "NAPROSYN 250", mrp: 8 },
    { name: "NAPROSYN 500", mrp: 10.57 },
    { name: "NAPROSYN 750", mrp: 9.2 },
    { name: "NEOSPORIN OINT", mrp: 131 },
    { name: "NERVIC OD", mrp: 17.50 },
    { name: "NEUROBION FORTE", mrp: 1.50 },
    { name: "NIDOGEN 500", mrp: 260 },
    { name: "Normaxin Rt", mrp: 6.50 },
    { name: "NU ALL D60 1G", mrp: 22 },
    { name: "NVG", mrp: 11.66 },
    { name: "OCID L", mrp: 21 },
    { name: "Odoxil 500", mrp: 7.50 },
    { name: "OFLOWIN 400", mrp: 13.50 },
    { name: "Oflomac 200", mrp: 9.70 },
    { name: "Oflomac 300", mrp: 16 },
    { name: "Oflomac M Forte", mrp: 97 },
    { name: "Oflomac M Syp", mrp: 69.50 },
    { name: "OLEPTAL 150 TAB", mrp: 10 },
    { name: "OLEPTAL  300", mrp: 18.13 },
    { name: "OLIDIC GEL", mrp: 85 },
    { name: "OMEE CAP", mrp: 3.30 },
    { name: "OMEE D CAP", mrp: 6.50 },
    { name: "Omnacortil Drops", mrp: 44.25 },
    { name: "Omnacortil Syp 60ml", mrp: 32.92 },
    { name: "Osil Cap", mrp: 21.73 },
    { name: "Osil Cream 30gm", mrp: 146 },
    { name: "OSSO XT TAB", mrp: 9 },
    { name: "OSSOPAN D SYP", mrp: 18.50 },
    { name: "OSTA D3 INJ 1ML", mrp: 59 },
    { name: "OSTEOFOS 70", mrp: 86 },
    { name: "OSTOCALCIUM", mrp: 221.91 },
    { name: "OVACARE", mrp: 27.66 },
    { name: "OVRAL L", mrp: 66.50 },
    { name: "P PPI 40", mrp: 4.50 },
    { name: "PLACIDA 10", mrp: 9.65 },
    { name: "POLMAFORCE", mrp: 12 },
    { name: "Prax A 75", mrp: 2 },
    { name: "PROSTAGARD 8", mrp: 22.50 },
    { name: "PROTHIADEN", mrp: 13 },
    { name: "PROTHIADEN 75", mrp: 27.20 },
    { name: "PYZINA 1000", mrp: 11 },
    { name: "PYZINA 750", mrp: 6.75 },
    { name: "Raciper 40", mrp: 12 },
    { name: "RANTAC 150", mrp: 1.7 },
    { name: "RANTAC 300", mrp: 3.2 },
    { name: "RANTAC OD", mrp: 8 },
    { name: "RCIN 600", mrp: 9.50 },
    { name: "RCINEX 600", mrp: 17.7 },
    { name: "REJOINT NEW", mrp: 48.75 },
    { name: "ROZOTIL MD", mrp: 8 },
    { name: "SAAZ DS", mrp: 17.5 },
    { name: "Serenace 0.25", mrp: 2.50 },
    { name: "Shelcal 500", mrp: 10.50 },
    { name: "Shelcal Hd", mrp: 10 },
    { name: "SHOVITAL GOLD", mrp: 23.5 },
    { name: "Sporidex Cv 375", mrp: 26 },
    { name: "Sporidex Paed Drops", mrp: 106 },
    { name: "SPPIL", mrp: 9 },
    { name: "STEMETIL MD", mrp: 13 },
    { name: "Superspas Rf", mrp: 6.80 },
    { name: "SURECOX 90", mrp: 10 },
    { name: "TBECT CRM", mrp: 115 },
    { name: "Telvas 3d", mrp: 11.40 },
    { name: "Telvas 40", mrp: 6.72 },
    { name: "Telvas Am", mrp: 9.66 },
    { name: "Telvas Beta 25", mrp: 12.40 },
    { name: "Telvas H 40/12.5", mrp: 9.20 },
    { name: "Tenefit M Forte", mrp: 11.50 },
    { name: "Terbitotal 250", mrp: 15 },
    { name: "Terbitotal 500", mrp: 27 },
    { name: "TERMADURE PLUS", mrp: 9.29 },
    { name: "Thyrox 100", mrp: 180 },
    { name: "Thyrox 12.5", mrp: 198.90 },
    { name: "Thyrox 125", mrp: 227.13 },
    { name: "Thyrox 25", mrp: 194.39 },
    { name: "Thyrox 50", mrp: 140.83 },
    { name: "TOPP 40", mrp: 4.50 },
    { name: "TRYPTOMER 10", mrp: 3 },
    { name: "TRYPTOMER 25", mrp: 3 },
    { name: "Ulgeraft Syp", mrp: 167 },
    { name: "Ulvin 500mg", mrp: 14.50 },
    { name: "UNIBEE LC", mrp: 13 },
    { name: "URIHOLD S 25", mrp: 197 },
    { name: "URIMAX 0.4 CAP", mrp: 17.30 },
    { name: "URIMAX D", mrp: 41.75 },
    { name: "VERTIGON 25", mrp: 6.50 },
    { name: "VERTIGON 75", mrp: 9.60 },
    { name: "VETORI 90", mrp: 11 },
    { name: "VH3", mrp: 100 },
    { name: "VILDAGARD 1000", mrp: 12.33 },
    { name: "Vildagard M 50/500", mrp: 9.67 },
    { name: "VIZYLAC CAP", mrp: 6.1 },
    { name: "VOLITRA APS", mrp: 348 },
    { name: "WINOCID D", mrp: 6.50 },
    { name: "XOCLAVE 625", mrp: 18.50 },
    { name: "Zedocef 200", mrp: 20.50 },
    { name: "Zedott 30 Dt", mrp: 17 },
    { name: "ZYLORIC 100", mrp: 2 },
          ];
          saveProductsToStorage(defaultProducts);
          return defaultProducts;
      }
  }

  // Save products to localStorage
  function saveProductsToStorage(productsArray) {
      localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(productsArray));
  }

  // Add new product
  function addNewProduct() {
      const name = $('#new-product-name').val().trim();
      const mrp = parseFloat($('#new-product-mrp').val());
      
      if (!name) {
          showStatus('Please enter product name', 'error');
          return;
      }
      
      if (isNaN(mrp) || mrp <= 0) {
          showStatus('Please enter valid MRP', 'error');
          return;
      }
      
      // Check if product already exists
      const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
      if (existingProduct) {
          showStatus('Product already exists!', 'error');
          return;
      }
      
      // Add new product
      const newProduct = { name: name.toUpperCase(), mrp: mrp };
      products.push(newProduct);
      
      // Save to localStorage
      saveProductsToStorage(products);
      
      // Close modal and show success
      $('#add-product-modal').hide();
      showStatus(`Product "${name}" added successfully!`, 'success');
      
      // Clear form
      $('#new-product-name').val('');
      $('#new-product-mrp').val('');
  }

  // Initialize product management
  function initProductManagement() {
      // Load products from localStorage
      products = loadProducts();
      
      // Add product button event
      $('#add-product-btn').click(function() {
          $('#add-product-modal').show();
      });
      
      // Save new product event
      $('#save-new-product').click(addNewProduct);
      
      // Close modal
      $('#add-product-modal .close').click(function() {
          $('#add-product-modal').hide();
      });
  }

  // ================= DATA STORAGE FUNCTIONS =================
  
  function getPatientFileName(patientName) {
    const safeName = patientName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    return `${DATA_PREFIX}${safeName}`;
  }

  function loadPatientData(patientName) {
    try {
      const fileName = getPatientFileName(patientName);
      const data = localStorage.getItem(fileName);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      return [];
    }
  }

  function savePatientData() {
    const name = $('#name').val().trim();
    if (!name) {
      showStatus('Please enter patient name', 'error');
      return;
    }

    const today = new Date();
    const dateStr = today.getFullYear() + "/" + 
                    String(today.getMonth() + 1).padStart(2, '0') + "/" + 
                    String(today.getDate()).padStart(2, '0');
    
    const timeStr = String(today.getHours()).padStart(2, '0') + ":" + 
                    String(today.getMinutes()).padStart(2, '0') + ":" + 
                    String(today.getSeconds()).padStart(2, '0');

    const billData = {
      date: dateStr,
      time: timeStr,
      timestamp: today.getTime(),
      products: [],
      subtotal: parseFloat($('#subtotal').text().replace('₹','')) || 0,
      discountPercent: parseInt($('#discount-percent').val()) || 0,
      discountFlat: parseFloat($('#discount-flat').val()) || 0,
      totalDiscount: parseFloat($('#total-discount').text().replace('₹','')) || 0,
      finalTotal: parseFloat($('#final-total').text().replace('₹','')) || 0
    };

    $('#products-body tr').each(function() {
      const productName = $(this).find('.product-search').val();
      const mrp = parseFloat($(this).find('.mrp-display').text()) || 0;
      const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
      const total = parseFloat($(this).find('.total-display').text().replace('₹','')) || 0;
      
      if (productName && quantity > 0) {
        billData.products.push({
          name: productName,
          mrp: mrp,
          quantity: quantity,
          total: total
        });
      }
    });

    if (billData.products.length === 0) {
      showStatus('Please add at least one product', 'error');
      return;
    }

    const patientData = loadPatientData(name);
    patientData.push(billData);
    
    const fileName = getPatientFileName(name);
    localStorage.setItem(fileName, JSON.stringify(patientData));
    
    showStatus(`Data saved for ${name} on ${dateStr} ${timeStr}`, 'success');
    updatePatientList();
    updateBackupStatus();
  }

  function updatePatientList() {
    const patientNames = [];
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        const patientName = key.replace(DATA_PREFIX, '');
        const displayName = patientName.replace(/_/g, ' ');
        patientNames.push(displayName);
      }
    }
    
    patientNames.sort();
    
    const datalist = $('#patient-list');
    datalist.empty();
    
    patientNames.forEach(name => {
      datalist.append(`<option value="${name}">`);
    });
  }

  function showStatus(message, type = 'info') {
    const statusDiv = $('#status-message');
    statusDiv.removeClass('status-success status-error status-info status-warning')
             .addClass(`status-${type} status-message`)
             .text(message)
             .show();
    
    setTimeout(() => {
      statusDiv.fadeOut();
    }, 5000);
  }

  // ================= BACKUP & RESTORE FUNCTIONS =================
  
  function getAllPatientData() {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        const patientName = key.replace(DATA_PREFIX, '');
        try {
          allData[patientName] = JSON.parse(localStorage.getItem(key));
        } catch (e) {
          console.error('Error parsing data for:', patientName);
        }
      }
    }
    return allData;
  }

  // FIXED: Export now includes product data
  function exportToJSON() {
    const allData = {
      patients: getAllPatientData(),
      products: JSON.parse(localStorage.getItem(PRODUCTS_STORAGE_KEY) || '[]'),
      exportDate: new Date().toISOString(),
      exportType: 'full_backup'
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `patient_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // Update backup timestamp
    localStorage.setItem('last_backup', new Date().toISOString());
    updateBackupStatus();
    
    showStatus('Full data exported successfully!', 'success');
  }

  function exportToCSV() {
    const allData = getAllPatientData();
    let csvContent = 'Patient Name,Date,Time,Product,MRP,Quantity,Total,Discount %,Discount Amount,Final Total\n';
    
    for (const patientName in allData) {
      if (allData.hasOwnProperty(patientName)) {
        const records = allData[patientName];
        records.forEach(record => {
          record.products.forEach(product => {
            csvContent += `"${patientName.replace(/_/g, ' ')}","${record.date}","${record.time}","${product.name}",${product.mrp},${product.quantity},${product.total},${record.discountPercent},${record.discountFlat},${record.finalTotal}\n`;
          });
        });
      }
    }
    
    const dataBlob = new Blob([csvContent], {type: 'text/csv'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `patient_backup_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('last_backup', new Date().toISOString());
    updateBackupStatus();
    
    showStatus('CSV exported successfully!', 'success');
  }

  // FIXED: Import now handles product data
  function importFromFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        
        // Check if it's the new format with products or old format
        if (importedData.patients && importedData.products) {
          // New format with products
          restoreFullBackup(importedData);
        } else {
          // Old format - only patient data
          restorePatientDataOnly(importedData);
        }
        
      } catch (error) {
        showStatus('Error importing file: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
  }

  function restoreFullBackup(importedData) {
    // Clear existing data
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX) || key === PRODUCTS_STORAGE_KEY) {
        localStorage.removeItem(key);
      }
    }
    
    // Restore patient data
    for (const patientName in importedData.patients) {
      if (importedData.patients.hasOwnProperty(patientName)) {
        localStorage.setItem(DATA_PREFIX + patientName, JSON.stringify(importedData.patients[patientName]));
      }
    }
    
    // Restore products
    if (importedData.products && importedData.products.length > 0) {
      localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(importedData.products));
      products = importedData.products; // Update in-memory products
    }
    
    updatePatientList();
    updateBackupStatus();
    showStatus('Full backup restored successfully!', 'success');
  }

  function restorePatientDataOnly(importedData) {
    // Old import logic for backward compatibility
    const currentData = getAllPatientData();
    const mergedData = {...currentData, ...importedData};
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        localStorage.removeItem(key);
      }
    }
    
    for (const patientName in mergedData) {
      if (mergedData.hasOwnProperty(patientName)) {
        localStorage.setItem(DATA_PREFIX + patientName, JSON.stringify(mergedData[patientName]));
      }
    }
    
    updatePatientList();
    updateBackupStatus();
    showStatus('Patient data imported successfully!', 'success');
  }

  function updateBackupStatus() {
    const lastBackup = localStorage.getItem('last_backup');
    if (lastBackup) {
      $('#last-backup-time').text(new Date(lastBackup).toLocaleString());
    } else {
      $('#last-backup-time').text('Never');
    }
    
    const allData = getAllPatientData();
    const patientCount = Object.keys(allData).length;
    const recordCount = Object.values(allData).reduce((total, records) => total + records.length, 0);
    const productCount = products.length;
    
    $('#backup-patient-count').text(patientCount);
    $('#backup-record-count').text(recordCount);
    $('#backup-product-count').text(productCount);
  }

  // ================= ENHANCED HISTORY MANAGEMENT =================
  function showEnhancedHistoryManagement() {
      const name = $('#name').val().trim();
      if (!name) {
          showStatus('Please enter patient name', 'error');
          return;
      }

      const patientData = loadPatientData(name);
      
      if (patientData.length === 0) {
          showStatus('No history found for this patient', 'error');
          return;
      }

      patientData.sort((a, b) => b.timestamp - a.timestamp);
      
      $('#history-patient-name').text(name);
      const historyList = $('#history-list');
      historyList.empty();
      
      // Add history management section
      const managementSection = `
          <div class="history-management">
              <h4><i class="fa fa-cog"></i> History Management</h4>
              <div class="history-actions">
                  <button class="btn btn-clear" id="delete-all-history">
                      <i class="fa fa-trash"></i> Delete All History
                  </button>
                  <button class="btn btn-export" id="export-patient-history">
                      <i class="fa fa-download"></i> Export Patient Data
                  </button>
              </div>
          </div>
      `;
      historyList.append(managementSection);
      
      patientData.forEach((record, index) => {
          const historyItem = `
              <div class="history-item" data-timestamp="${record.timestamp}">
                  <div class="history-date">
                      <span>Date: ${record.date} Time: ${record.time}</span>
                      <button class="delete-history-btn" data-timestamp="${record.timestamp}">
                          <i class="fa fa-trash"></i> Delete
                      </button>
                  </div>
                  <div class="history-products">
                      ${record.products.map(product => `
                          <div class="history-product">
                              <span>${product.name}</span>
                              <span>${product.quantity} × ₹${product.mrp.toFixed(2)} = ₹${product.total.toFixed(2)}</span>
                          </div>
                      `).join('')}
                  </div>
                  <div class="history-totals">
                      <div class="history-total-row">
                          <span>Total Amount:</span>
                          <span>₹${record.subtotal.toFixed(2)}</span>
                      </div>
                      <div class="history-total-row">
                          <span>Discount (${record.discountPercent}% + ₹${record.discountFlat}):</span>
                          <span>₹${record.totalDiscount.toFixed(2)}</span>
                      </div>
                      <div class="history-total-row final-amount">
                          <span>Final Payable Amount:</span>
                          <span>₹${record.finalTotal.toFixed(2)}</span>
                      </div>
                  </div>
              </div>
          `;
          historyList.append(historyItem);
      });
      
      // Add daily report section
      const dailyReportSection = `
          <div class="daily-report-section">
              <div class="daily-report-header">
                  <h4><i class="fa fa-calendar"></i> Daily Transaction Report</h4>
                  <div class="date-filter">
                      <input type="date" id="report-date" value="${new Date().toISOString().split('T')[0]}">
                      <button class="btn btn-save" id="load-daily-report">
                          <i class="fa fa-search"></i> Load Report
                      </button>
                  </div>
              </div>
              <div id="daily-report-content">
                  ${generateDailyReport(new Date().toISOString().split('T')[0])}
              </div>
          </div>
      `;
      historyList.append(dailyReportSection);
      
      // Attach event handlers
      attachHistoryManagementEvents(name);
      
      $('#history-modal').show();
  }

  function attachHistoryManagementEvents(patientName) {
      // Delete single transaction
      $('.delete-history-btn').off().click(function(e) {
          e.stopPropagation();
          const timestamp = $(this).data('timestamp');
          showDeleteConfirmation(patientName, timestamp, false);
      });
      
      // Delete all history
      $('#delete-all-history').off().click(function() {
          showDeleteConfirmation(patientName, null, true);
      });
      
      // Export patient data
      $('#export-patient-history').off().click(function() {
          exportPatientHistory(patientName);
      });
      
      // Load daily report
      $('#load-daily-report').off().click(function() {
          const date = $('#report-date').val();
          $('#daily-report-content').html(generateDailyReport(date));
      });
  }

  function showDeleteConfirmation(patientName, timestamp, deleteAll = false) {
      const message = deleteAll ? 
          'Are you sure you want to delete ALL history for this patient? This action cannot be undone.' :
          'Are you sure you want to delete this transaction? This action cannot be undone.';
      
      const confirmHtml = `
          <div class="confirm-delete">
              <strong>${message}</strong>
              <div class="confirm-buttons">
                  <button class="btn btn-clear confirm-yes">Yes, Delete</button>
                  <button class="btn btn-save confirm-no">Cancel</button>
              </div>
          </div>
      `;
      
      // Remove any existing confirmation
      $('.confirm-delete').remove();
      
      if (deleteAll) {
          $('#delete-all-history').after(confirmHtml);
      } else {
          $(`.delete-history-btn[data-timestamp="${timestamp}"]`).closest('.history-date').after(confirmHtml);
      }
      
      $('.confirm-yes').off().click(function() {
          if (deleteAll) {
              deleteAllPatientHistory(patientName);
          } else {
              deleteSingleTransaction(patientName, timestamp);
          }
      });
      
      $('.confirm-no').off().click(function() {
          $('.confirm-delete').remove();
      });
  }

  function deleteSingleTransaction(patientName, timestamp) {
      const patientData = loadPatientData(patientName);
      const updatedData = patientData.filter(record => record.timestamp !== timestamp);
      
      const fileName = getPatientFileName(patientName);
      localStorage.setItem(fileName, JSON.stringify(updatedData));
      
      showStatus('Transaction deleted successfully', 'success');
      showEnhancedHistoryManagement(); // Refresh the view
      updateBackupStatus();
  }

  function deleteAllPatientHistory(patientName) {
      const fileName = getPatientFileName(patientName);
      localStorage.removeItem(fileName);
      
      showStatus(`All history deleted for ${patientName}`, 'success');
      $('#history-modal').hide();
      updatePatientList();
      updateBackupStatus();
  }

  function exportPatientHistory(patientName) {
      const patientData = loadPatientData(patientName);
      const dataStr = JSON.stringify(patientData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `patient_${patientName.replace(/[^a-zA-Z0-9]/g, '_')}_history_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showStatus(`Patient history exported for ${patientName}`, 'success');
  }

  function generateDailyReport(date) {
    const allPatients = getAllPatientData();
    let reportHTML = '';
    let totalDayAmount = 0;
    let patientCount = 0;
    
    // Convert date from YYYY-MM-DD to YYYY/MM/DD format
    const formattedDate = date.replace(/-/g, '/');
    
    // Filter transactions for the selected date from ALL patients
    const dailyTransactions = {};
    
    for (const patientName in allPatients) {
        if (allPatients.hasOwnProperty(patientName)) {
            const displayName = patientName.replace(/_/g, ' ');
            const patientRecords = allPatients[patientName];
            
            const dayRecords = patientRecords.filter(record => record.date === formattedDate);
            
            if (dayRecords.length > 0) {
                dailyTransactions[displayName] = dayRecords;
                patientCount++;
                
                // Calculate total for this patient on this day
                const patientDayTotal = dayRecords.reduce((total, record) => total + record.finalTotal, 0);
                totalDayAmount += patientDayTotal;
            }
        }
    }
    
    if (Object.keys(dailyTransactions).length === 0) {
        return '<div class="no-history">No transactions found for ' + formattedDate + '</div>';
    }
    
    // Generate report HTML
    for (const [patientName, records] of Object.entries(dailyTransactions)) {
        const patientTotal = records.reduce((total, record) => total + record.finalTotal, 0);
        
        reportHTML += `
            <div class="patient-day-summary">
                <div class="patient-day-header">
                    <span class="patient-day-name">${patientName}</span>
                    <span class="patient-day-total">₹${patientTotal.toFixed(2)}</span>
                </div>
        `;
        
        records.forEach(record => {
            reportHTML += `
                <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-size: 12px; color: #666;">Time: ${record.time}</div>
                    <div style="margin-top: 4px;">
                        ${record.products.map(product => 
                            `<div style="font-size: 12px;">${product.name} (${product.quantity} × ₹${product.mrp.toFixed(2)}) = ₹${product.total.toFixed(2)}</div>`
                        ).join('')}
                    </div>
                    <div style="font-size: 12px; margin-top: 4px; font-weight: bold;">
                        Total: ₹${record.finalTotal.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        reportHTML += `</div>`;
    }
    
    // Add summary
    reportHTML = `
        <div style="margin-bottom: 15px; padding: 10px; background: #d4edda; border-radius: 6px; text-align: center;">
            <strong>Daily Summary for ${formattedDate}:</strong> ${patientCount} patients, Total Amount: ₹${totalDayAmount.toFixed(2)}
        </div>
        ${reportHTML}
    `;
    
    return reportHTML;
  }

  function getAllPatientData() {
      const allData = {};
      for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(DATA_PREFIX)) {
              const patientName = key.replace(DATA_PREFIX, '');
              try {
                  allData[patientName] = JSON.parse(localStorage.getItem(key));
              } catch (e) {
                  console.error('Error parsing data for:', patientName);
              }
          }
      }
      return allData;
  }

  // ================= AUTOCOMPLETE =================
  function initAutocompleteForRow(row) {
    row.find('.product-search').autocomplete({
      source: function(request, response) {
        const term = request.term.toLowerCase();
        const matches = products.filter(p => p.name.toLowerCase().includes(term)).map(p => p.name);
        response(matches);
      },
      minLength: 1,
      select: function(e, ui) {
        const product = products.find(p => p.name === ui.item.value);
        if (product) {
          row.find('.mrp-display').text(product.mrp.toFixed(2));
          calculateRowTotal(row);
        }
      }
    });
  }

  // ================= CALCULATE TOTALS =================
  function calculateRowTotal(row) {
    const mrp = parseFloat(row.find('.mrp-display').text()) || 0;
    let qtyVal = parseInt(row.find('.quantity-input').val());
    if (isNaN(qtyVal) || qtyVal <= 0) {
      qtyVal = 0;
      row.find('.quantity-input').val("");
      row.find('.quantity-input').addClass("no-qty");
    } else {
      row.find('.quantity-input').removeClass("no-qty");
    }
    const total = mrp * qtyVal;
    row.find('.total-display').text('₹' + total.toFixed(2));
    calculateTotal();
  }

  function calculateTotal() {
    let subtotal = 0;
    let productCount = 0;
    $('#products-body tr').each(function() {
      const total = parseFloat($(this).find('.total-display').text().replace('₹','')) || 0;
      const qtyVal = parseInt($(this).find('.quantity-input').val());
      if (!isNaN(qtyVal) && qtyVal > 0) productCount++;
      subtotal += total;
    });
    
    $('#subtotal').text('₹' + subtotal.toFixed(2));
    
    const discountPercent = parseInt($('#discount-percent').val()) || 0;
    const discountFlat = parseFloat($('#discount-flat').val()) || 0;
    
    const discountFromPercent = subtotal * (discountPercent / 100);
    const totalDiscount = discountFromPercent + discountFlat;
    const finalTotal = Math.max(0, subtotal - totalDiscount);
    
    $('#total-discount').text('₹' + totalDiscount.toFixed(2));
    $('#final-total').text('₹' + finalTotal.toFixed(2));
    $('#total-products-display').text("Count: " + productCount);
    
    const discountMessage = $('#discount-message');
    if (discountPercent > 0 || discountFlat > 0) {
      let message = "";
      if (discountPercent > 0 && discountFlat > 0) {
        message = `Discount applied: ${discountPercent}% (₹${discountFromPercent.toFixed(2)}) + ₹${discountFlat.toFixed(2)} = ₹${totalDiscount.toFixed(2)}`;
      } else if (discountPercent > 0) {
        message = `Discount applied: ${discountPercent}% = ₹${discountFromPercent.toFixed(2)}`;
      } else if (discountFlat > 0) {
        message = `Discount applied: ₹${discountFlat.toFixed(2)}`;
      }
      discountMessage.text(message).show();
    } else {
      discountMessage.hide();
    }
  }

  function attachEvents() {
    $('.quantity-input').off().on('input', function() {
      calculateRowTotal($(this).closest('tr'));
    });
  }

  // ================= INITIALIZE =================
  
  // Initialize product management FIRST
  initProductManagement();
  
  // Then initialize autocomplete
  initAutocompleteForRow($('#products-body tr'));
  attachEvents();
  
  updatePatientList();
  updateBackupStatus();
  
  $('#save-btn').click(savePatientData);
  $('#history-btn').click(showEnhancedHistoryManagement);
  $('#backup-btn').click(function() {
    $('#backup-modal').show();
  });
  
  // Backup functionality
  $('#export-json').click(exportToJSON);
  $('#export-csv').click(exportToCSV);
  $('#import-btn').click(function() {
    $('#import-file').click();
  });
  
  $('#import-file').change(function(e) {
    if (e.target.files.length > 0) {
      importFromFile(e.target.files[0]);
    }
  });

  $('.close').click(function() {
    $('#history-modal, #backup-modal, #add-product-modal').hide();
  });
  
  $(window).click(function(event) {
    if ($(event.target).is('.modal')) {
      $('.modal').hide();
    }
  });

  $('#add-row').click(function() {
    const newRow = $(`
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    `);
    $('#products-body').append(newRow);
    initAutocompleteForRow(newRow);
    attachEvents();
  });

  $('#clear-all').click(function() {
    $('#products-body').empty();
    const newRow = $(`
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    `);
    $('#products-body').append(newRow);
    initAutocompleteForRow(newRow);
    attachEvents();
    
    $('#name').val("");
    $('#discount-percent').val("");
    $('#discount-flat').val("");
    calculateTotal();
  });

  $('#discount-percent, #discount-flat').on('input', calculateTotal);

  // ================= SCREENSHOT =================
  $('#screenshot-btn').click(function() {
    const name = $('#name').val() || "NoName";
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}${mm}${dd}`;
    const fileName = `${name}_${dateStr}.png`;
    
    html2canvas(document.querySelector("#billing-container")).then(canvas => {
      const link = document.createElement("a");
      link.download = fileName;
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  });
});
</script>
</body>
</html>
