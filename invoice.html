<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Invoice</title>
<!-- External Libraries -->
<script type="text/javascript" nonce="67f3fd63391448979438518f934" src="//local.adguard.org?ts=1762499580533&type=content-script&dmn=kaleemx2.github.io&url=https%3A%2F%2Fkaleemx2.github.io%2Fayat%2Finvoice.html&app=mark.via.gp&css=3&js=1&rel=1&rji=1&sbe=1&stealth=1&st-dnt"></script>
<script type="text/javascript" nonce="67f3fd63391448979438518f934" src="//local.adguard.org?ts=1762499580533&name=AdGuard%20Extra&type=user-script"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* ======================= MAIN CSS STYLES ======================= */

/* CSS Reset - Removes default browser styling */
* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
  font-family: 'Segoe UI', Tahoma, sans-serif; 
}

/* Body styling with light gray background */
body { 
  background: #e0e5ec; 
  padding: 10px; 
}

/* Main container with white background and shadow */
.container {
  background: #fff; 
  border-radius: 12px; 
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  width: 100%; 
  max-width: 760px; 
  padding: 20px;
  position: relative;
}

/* ================= HEADER STYLES ================= */
.header { 
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px; 
}

/* Patient name input field */
.header input {
  border: none; 
  font-size: 24px; 
  font-weight: 700; 
  text-align: center;
  width: 100%; 
  border-bottom: 3px solid #ddd; 
  padding: 8px; 
  outline: none;
  border-radius: 6px; 
  background: #f8f8f8 !important; /* FIX: Force background to prevent transparency */
  flex: 1;
  color: #000 !important; /* FIX: Ensure text is visible */
}

/* Date and product count display */
#simplified-info {
  display: flex;
  justify-content: flex-start;
  gap: 20px;
  width: 100%; 
}

#simplified-info div {
  font-size: 14px;
  font-weight: 600;
  color: #222;
  text-align: left;
  flex: 0 0 auto;  
} 

/* ================= PRODUCTS TABLE STYLES ================= */
.products-table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0 8px; 
  margin-bottom: 15px; 
}

.products-table th, .products-table td {
  padding: 10px 8px; 
  font-size: 15px; 
  text-align: left;
}

.products-table th { 
  background: #f1f3f6; 
  color: #555; 
  font-weight: 600; 
}

.products-table td { 
  background: #f9f9f9; 
  border-radius: 8px; 
  vertical-align: middle; 
}

/* Product search input */
.product-search { 
  width: 100%; 
  padding: 10px; 
  border: 1px solid #ccc; 
  border-radius: 8px; 
}   

/* Quantity input with color coding */
.quantity-input {
  width: 60px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  text-align: center;
  font-weight: 700;  
  font-size: 15px;
  background-color: #f8d7da; /* Red background when empty */
  color: #721c24;
  transition: background 0.3s, color 0.3s;
}

.quantity-input:not(:placeholder-shown) {
  background-color: #fff; /* White background when has value */
  color: #000;
}

.mrp-display, .total-display { 
  display: block; 
  text-align: right; 
  font-weight: 600; 
  color: #222; 
}

/* ================= BUTTON STYLES ================= */
.action-buttons { 
  display: flex; 
  justify-content: space-between; 
  gap: 15px; 
  margin-bottom: 15px;
  width: 100%;
}

.action-buttons .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.bottom-buttons {
  display: flex;
  justify-content: space-between;
  gap: 15px;
  margin-top: 10px;
  width: 100%;
}

.bottom-buttons .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

/* Base button style */
.btn { 
  padding: 8px 16px; 
  font-size: 14px; 
  font-weight: 600; 
  border: none; 
  border-radius: 6px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 5px; 
  transition: all 0.3s;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Button color variants */
.btn-clear { background: #ff6b6b; color: #fff; }
.btn-add { background: #1dd1a1; color: #fff; }
.btn-save { background: #1976d2; color: #fff; }
.btn-history { background: #ff9800; color: #fff; }
.btn-sync { background: #9c27b0; color: #fff; }
.btn-export { background: #4caf50; color: #fff; }
.btn-import { background: #ff9800; color: #fff; }

/* ================= SUMMARY SECTION STYLES ================= */
.summary-section { margin-top: 10px; }

.summary-row { 
  display: flex; 
  justify-content: space-between; 
  padding: 8px 0; 
  font-size: 14px; 
  align-items: center;
}   

.summary-row span:last-child {
  font-weight: 700;  
  color: #000;
}

.summary-row.final-total span:last-child {
  font-weight: 700;
  color: #1976d2;
}

#subtotal, #discount-amount, #total-discount {
  font-size: 16px;
} 

.final-total { 
  border-top: 2px solid #ddd; 
  margin-top: 8px; 
  font-size: 16px; 
  font-weight: 700; 
  color: #1976d2; 
}

.discount-input { 
  width: 70px; 
  padding: 6px; 
  border: 1px solid #ddd; 
  border-radius: 6px; 
  text-align: center; 
  background: #fff; 
  color: #000; 
  font-weight: 600;
}

/* ================= SCREENSHOT BUTTON ================= */
.screenshot-btn {
  position: absolute; 
  top: 10px; 
  right: 10px;
  background: #1976d2; 
  color: #fff; 
  border: none; 
  padding: 8px 12px; 
  font-size: 14px; 
  font-weight: 600; 
  border-radius: 6px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  gap: 5px;
  transition: all 0.3s;
}

.screenshot-btn:hover { 
  background: #125aa0; 
  transform: translateY(-2px);
}

/* ================= STATUS MESSAGE STYLES ================= */
.status-message {
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  text-align: center;
  font-weight: 600;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.status-info {
  background: #cce7ff;
  color: #004085;
  border: 1px solid #b3d7ff;
}

.status-warning {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

/* ================= MODAL STYLES ================= */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: none;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: #000;
}

/* ================= HISTORY MANAGEMENT STYLES ================= */
.history-item {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  background: #f9f9f9;
}

.history-date {
  font-weight: bold;
  color: #1976d2;
  margin-bottom: 10px;
  font-size: 16px;
}

.history-products {
  margin: 10px 0;
}

.history-product {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
  font-size: 14px;
}

.history-totals {
  border-top: 1px solid #ddd;
  padding-top: 10px;
  margin-top: 10px;
}

.history-total-row {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
}

.final-amount {
  color: #1976d2;
  font-size: 16px;
}

.discount-message {
  font-size: 12px;
  color: #28a745;
  font-weight: 600;
  margin-top: 5px;
  text-align: center;
  display: none;
}

/* ================= BACKUP SECTION STYLES ================= */
.backup-section {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin: 10px 0;
  border: 1px solid #dee2e6;
}

.backup-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.backup-buttons .btn {
  flex: 1;
  justify-content: center;
}

/* ================= AUTCOMPLETE DROPDOWN STYLES ================= */
.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #1976d2;
    border-radius: 8px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.ui-menu .ui-menu-item {
    padding: 10px 10px;
    border-bottom: 2px solid #ddd;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.2s;
}

.ui-menu .ui-menu-item:last-child {
    border-bottom: none;
}

.ui-menu .ui-menu-item:hover {
    background: #e3f2fd;
    color: #1976d2;
    border-left: 3px solid #1976d2;
}

.ui-menu .ui-state-active, 
.ui-menu .ui-state-focus {
    background: #1976d2 !important;
    color: white !important;
    border: none !important;
    margin: 0 !important;
}

.ui-autocomplete .ui-menu-item-wrapper {
    padding: 8px 12px !important;
}

/* ================= RESPONSIVE STYLES ================= */
@media (max-width: 600px) {
  .info-section { justify-content: center; }
  .action-buttons { flex-direction: row; gap: 10px; }
  .action-buttons .btn { min-width: 100px; font-size: 13px; padding: 8px 12px; }
  .bottom-buttons { flex-direction: row; gap: 10px; }
  .bottom-buttons .btn { min-width: 100px; font-size: 13px; padding: 8px 12px; }
  .products-table td { font-size: 14px; padding: 8px; }
  .product-search { padding: 8px; font-size: 14px; }
  .quantity-input { width: 50px; padding: 4px; }
  .header { flex-direction: column; gap: 10px; }
  .header input { font-size: 20px; }
}

@media (max-width: 400px) {
  .action-buttons .btn, .bottom-buttons .btn { 
    min-width: 90px; font-size: 12px; padding: 6px 10px; 
  }
}

/* ================= ADDITIONAL UTILITY STYLES ================= */
.divider {
  height: 1px;
  background: #ddd;
  margin: 15px 0;
}

.sync-status {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 1001;
}

/* Form group styling for modals */
.form-group {
  margin: 15px 0;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  color: #333;
}

#new-product-name, #new-product-mrp {
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 16px;
}

#new-product-name:focus, #new-product-mrp:focus {
  border-color: #1976d2;
  outline: none;
}

/* NEW: Product management styles */
.product-item {
  transition: all 0.3s ease;
}

.product-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-edit-form input:focus {
  border-color: #1976d2 !important;
  outline: none;
  box-shadow: 0 0 5px rgba(25, 118, 210, 0.3);
}

/* Drop Down Menu */
.hdr-menu {
  position: relative;
  display: inline-block;
}

/* Menu button only */
#hdrMenuBtn {
  background-color: #f0f0f0; /* Light gray background for the button */
  color: #333;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap; /* Prevents word breaking */
}

/* Drop Down Menu list */
.hdr-menu .menu-list {
  display: none;
  position: absolute;
  right: 0;
  top: 40px;
  background: #f9f9f9;
  border: 1px solid #e6e9ef;
  border-radius: 6px;
  padding: 8px;
  box-shadow: 0 6px 18px rgba(15,20,40,0.08);
  z-index: 200;
}

/* Buttons inside dropdown */
.hdr-menu .menu-list button {
  display: block;
  width: 100%;
  text-align: left;
  background: transparent;
  color: #333;
  border: 1px solid red;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap; /* Prevents word breaking */
  margin-bottom: 10px;
}

/* Flex alignment */
.top-bar {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 20px;
}

.info-section,
.hdr-menu {
  display: flex;
  align-items: center;
}
</style>
</head>

<body>
<!-- ================= MAIN HTML STRUCTURE ================= -->
<div class="container" id="billing-container">
  <!-- Screenshot button for capturing the bill -->
  <button class="screenshot-btn" id="screenshot-btn">
    <i class="fa fa-camera"></i> 
  </button>
  
  <!-- Patient name input with datalist for autocomplete -->
  <div class="header">
    <input type="text" id="name" placeholder="PATIENT NAME" list="patient-list">
    <datalist id="patient-list"></datalist>
  </div>
  
  
  
 <div class="top-bar">
  <!-- Date display section -->
  <div class="info-section" id="simplified-info">
    <div id="date-display">10 Nov 2025</div>
  </div>

  <!-- Drop Down Menu -->
  <div class="hdr-menu">
    <button id="hdrMenuBtn" class="small"><i class="fa fa-bars"></i> Menu</button>
    <div id="hdrMenu" class="menu-list" aria-hidden="true">
	  <button class="btn btn-add" id="add-product-btn"><i class="fa fa-capsules"></i> Add Product</button>
      <button class="btn btn-add" id="manage-products-btn"><i class="fa fa-edit"></i> Edit Product</button>
      <button class="btn btn-clear" id="clear-all-menu"><i class="fa fa-trash"></i> Clear All</button>
    </div>
  </div>
</div>



  <!-- Products table for billing items -->
  <table class="products-table">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>MRP</th>
        <th>QTY</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="products-body">
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    </tbody>
  </table>
  
  <!-- Total products count display -->
  <div class="info-section" id="simplified-info">
    <div id="total-products-display"></div>
  </div>
  
  <!-- Action buttons for managing the bill -->
  <div class="action-buttons">
    <button class="btn btn-add" id="add-row"><i class="fa fa-plus"></i> Row</button>
    <button class="btn btn-clear" id="clear-all"><i class="fa fa-trash"></i> Clear</button>
  </div>
  
  <!-- Summary section with totals and discounts -->
  <div class="summary-section">
    <div class="summary-row"><span>Total All</span><span id="subtotal">₹0.00</span></div>
    
    <div class="summary-row">
      <span>Dis. %</span>
      <input type="number" class="discount-input" id="discount-percent" value="" min="0" max="100" placeholder="0">
      <span>Dis. (₹)</span>
      <input type="number" class="discount-input" id="discount-flat" value="" min="0" placeholder="0">
    </div>
    
    <div class="summary-row">
      <span>Total Discount</span>
      <span id="total-discount">₹0.00</span>
    </div>
    
    <div class="summary-row final-total">
      <span>Final Total</span>
      <span id="final-total">₹0.00</span>
    </div>
    
    <div id="discount-message" class="discount-message"></div>
  </div>
  
  <div class="divider"></div>
  
  <!-- Bottom action buttons -->
  <div class="bottom-buttons">
    <button class="btn btn-save" id="save-btn"><i class="fa fa-save"></i> Save</button>
    <button class="btn btn-history" id="history-btn"><i class="fa fa-history"></i> History</button>
    <button class="btn btn-sync" id="backup-btn"><i class="fa fa-download"></i> Backup</button>
  </div>

  <!-- Status message display area -->
  <div id="status-message"></div>
</div>

<!-- ================= MODAL DIALOGS ================= -->

<!-- Patient History Modal -->
<div id="history-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Patient History - <span id="history-patient-name"></span></h3>
    <div id="history-list"></div>
  </div>
</div>

<!-- Backup Modal -->
<div id="backup-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3><i class="fa fa-download"></i> Data Backup & Restore</h3>
    
    <div class="backup-section">
      <h4><i class="fa fa-download"></i> Export Data</h4>
      <p>Download all patient data as a backup file:</p>
      <div class="backup-buttons">
        <button class="btn btn-export" id="export-json"><i class="fa fa-file-code"></i> Export JSON</button>
        <button class="btn btn-export" id="export-csv"><i class="fa fa-file-excel"></i> Export CSV</button>
      </div>
    </div>

    <div class="backup-section">
      <h4><i class="fa fa-upload"></i> Import Data</h4>
      <p>Restore patient data from backup file:</p>
      <div class="backup-buttons">
        <input type="file" id="import-file" accept=".json,.csv" style="display: none;">
        <button class="btn btn-import" id="import-btn"><i class="fa fa-upload"></i> Import Backup</button>
      </div>
    </div>

    <div class="backup-section">
      <h4><i class="fa fa-info-circle"></i> Backup Status</h4>
      <div id="backup-status" class="status-message status-info">
        Last Backup: <span id="last-backup-time">Never</span><br>
        Total Patients: <span id="backup-patient-count">0</span><br>
        Total Records: <span id="backup-record-count">0</span><br>
        Total Products: <span id="backup-product-count">0</span>
      </div>
    </div>

    <div class="backup-section status-warning">
      <h4><i class="fa fa-exclamation-triangle"></i> Important</h4>
      <p>Regularly backup your data to avoid loss. Browser data can be cleared automatically.</p>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="add-product-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <span class="close">&times;</span>
    <h3><i class="fa fa-plus"></i> Add New Product</h3>
    
    <div class="backup-section">
      <div class="form-group">
        <label>Product Name:</label>
        <input type="text" id="new-product-name" class="product-search" placeholder="Enter product name" style="width: 100%; padding: 10px; margin: 8px 0;">
      </div>
      
      <div class="form-group">
        <label>MRP (₹):</label>
        <input type="number" id="new-product-mrp" step="0.01" placeholder="Enter MRP" style="width: 100%; padding: 10px; margin: 8px 0;">
      </div>
      
      <div class="backup-buttons">
        <button class="btn btn-save" id="save-new-product">
          <i class="fa fa-save"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- NEW: Manage Products Modal -->
<div id="manage-products-modal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <span class="close">&times;</span>
    <h3><i class="fa fa-edit"></i> Manage Products</h3>
    
    <div class="backup-section">
      <div class="form-group">
        <label>Search Product:</label>
        <input type="text" id="search-product" class="product-search" placeholder="Search products..." style="width: 100%; padding: 10px; margin: 8px 0;">
      </div>
      
      <div id="products-list" style="max-height: 400px; overflow-y: auto; margin: 15px 0;">
        <!-- Products will be listed here dynamically -->
      </div>
      
      <div class="backup-buttons">
        <button class="btn btn-save" id="close-manage-products">
          <i class="fa fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================= JAVASCRIPT FUNCTIONALITY ======================= */

// Main function that runs when the document is ready
$(document).ready(function() {
  // Constants for localStorage keys
  const DATA_PREFIX = "patient_history_"; // Prefix for patient data in localStorage
  const PRODUCTS_STORAGE_KEY = "custom_products_list"; // Key for storing products

  // ================= DATE DISPLAY INITIALIZATION =================
  // Display current date in the format YYYY/MM/DD
  const today = new Date();
  const formattedDate = today.getFullYear() + "/" + 
                        String(today.getMonth() + 1).padStart(2, '0') + "/" + 
                        String(today.getDate()).padStart(2, '0');
  $('#date-display').text("Date: " + formattedDate);

  // ================= PRODUCT MANAGEMENT SYSTEM =================
  let products = []; // Array to store all products

  // Load products from localStorage or initialize with default products
  function loadProducts() {
      const savedProducts = localStorage.getItem(PRODUCTS_STORAGE_KEY);
      if (savedProducts) {
          return JSON.parse(savedProducts);
      } else {
          // Default products if none exist
          const defaultProducts = [
            { name: "Medicine", mrp: 1 },
          ];
          saveProductsToStorage(defaultProducts);
          return defaultProducts;
      }
  }

  // Save products array to localStorage
  function saveProductsToStorage(productsArray) {
      localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(productsArray));
  }

  // Add a new product to the system
  function addNewProduct() {
      const name = $('#new-product-name').val().trim();
      const mrp = parseFloat($('#new-product-mrp').val());
      
      if (!name) {
          showStatus('Please enter product name', 'error');
          return;
      }
      
      if (isNaN(mrp) || mrp <= 0) {
          showStatus('Please enter valid MRP', 'error');
          return;
      }
	  
// Add a new product to the system
function addNewProduct() {
    const name = $('#new-product-name').val().trim();
    const mrp = parseFloat($('#new-product-mrp').val());
    
    if (!name) {
        showStatus('Please enter product name', 'error');
        return;
    }
    
    if (isNaN(mrp) || mrp <= 0) {
        showStatus('Please enter valid MRP', 'error');
        return;
    }
    
    // Check if product already exists
    const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
    if (existingProduct) {
        showStatus('Product already exists!', 'error');
        return;
    }
    
    // Add new product to the array
    const newProduct = { name: name.toUpperCase(), mrp: mrp };
    products.push(newProduct);
    
    // Save to localStorage
    saveProductsToStorage(products);
    
    // Close modal and show success message
    $('#add-product-modal').hide();
    showStatus(`Product "${name}" added successfully!`, 'success');
    
    // Clear form inputs
    $('#new-product-name').val('');
    $('#new-product-mrp').val('');
    
    // CORRECT POSITION: Add this line HERE (at the very end)
    if ($('#manage-products-modal').is(':visible')) {
        loadProductsList();
    }
}
	  
      
      // Check if product already exists
      const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
      if (existingProduct) {
          showStatus('Product already exists!', 'error');
          return;
      }
      
      // Add new product to the array
      const newProduct = { name: name.toUpperCase(), mrp: mrp };
      products.push(newProduct);
      
      // Save to localStorage
      saveProductsToStorage(products);
      
      // Close modal and show success message
      $('#add-product-modal').hide();
      showStatus(`Product "${name}" added successfully!`, 'success');
      
      // Clear form inputs
      $('#new-product-name').val('');
      $('#new-product-mrp').val('');
  }

  // NEW: Show the manage products modal
  function showManageProductsModal() {
    $('#manage-products-modal').show();
    loadProductsList();
  }

// NEW: Load and display the products list (REPLACE THIS FUNCTION)
function loadProductsList() {
  const searchTerm = $('#search-product').val().toLowerCase();
  const productsList = $('#products-list');
  productsList.empty();
  
  // Sort products alphabetically by name
  const sortedProducts = [...products].sort((a, b) => 
    a.name.localeCompare(b.name)
  );
  
  // Filter products based on search term (use sortedProducts instead of products)
  const filteredProducts = sortedProducts.filter(product => 
    product.name.toLowerCase().includes(searchTerm)
  );
  
  if (filteredProducts.length === 0) {
    productsList.html('<div class="no-history" style="text-align: center; padding: 20px;">No products found</div>');
    return;
  }
  
  // Create HTML for each product
  filteredProducts.forEach((product) => {
    // FIXED: Find the actual index in the original products array
    const actualIndex = products.findIndex(p => p.name === product.name && p.mrp === product.mrp);
    
    const productHtml = `
      <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin: 8px 0; background: white;">
        <div style="flex: 1;">
          <div style="font-weight: bold; color: #1976d2;">${product.name}</div>
          <div style="font-size: 14px; color: #666;">MRP: ₹${product.mrp.toFixed(2)}</div>
        </div>
        <div>
          <button class="btn btn-save edit-product-btn" data-index="${actualIndex}" style="padding: 6px 12px; margin: 0 4px;">
            <i class="fa fa-edit"></i> Edit
          </button>
          <button class="btn btn-clear delete-product-btn" data-index="${actualIndex}" style="padding: 6px 12px; margin: 0 4px;">
            <i class="fa fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
    productsList.append(productHtml);
  });
  
  // Attach event handlers to edit and delete buttons
  $('.edit-product-btn').click(function() {
    const index = $(this).data('index');
    editProduct(index);
  });
  
  $('.delete-product-btn').click(function() {
    const index = $(this).data('index');
    deleteProduct(index);
  });
}

// NEW: Edit a product (REPLACE THIS FUNCTION)
function editProduct(index) {
  const product = products[index];
  
  // Create edit form HTML
  const editHtml = `
    <div class="product-edit-form" style="display: flex; gap: 10px; align-items: center; padding: 12px; border: 2px solid #1976d2; border-radius: 6px; margin: 8px 0; background: #f0f8ff;">
      <div style="flex: 1;">
        <input type="text" class="edit-product-name" value="${product.name}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
        <input type="number" class="edit-product-mrp" value="${product.mrp}" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      <div>
        <button class="btn btn-save save-product-btn" data-index="${index}" style="padding: 6px 12px; margin: 0 4px;">
          <i class="fa fa-save"></i> Save
        </button>
        <button class="btn btn-clear cancel-edit-btn" data-index="${index}" style="padding: 6px 12px; margin: 0 4px;">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </div>
  `;
  
  // FIXED: Replace the product item with edit form using correct selector
  $(`.product-item:has(.edit-product-btn[data-index="${index}"])`).replaceWith(editHtml);
  
  // Attach save event
  $(`.save-product-btn[data-index="${index}"]`).click(function() {
    const saveIndex = $(this).data('index');
    saveProductEdit(saveIndex);
  });
  
  $(`.cancel-edit-btn[data-index="${index}"]`).click(function() {
    loadProductsList(); // Reload the list to cancel editing
  });
}

// NEW: Save product edits (REPLACE THIS FUNCTION)
function saveProductEdit(index) {
  // FIXED: Get values from the correct edit form
  const editForm = $(`.save-product-btn[data-index="${index}"]`).closest('.product-edit-form');
  const newName = editForm.find('.edit-product-name').val().trim();
  const newMrp = parseFloat(editForm.find('.edit-product-mrp').val());
  
  if (!newName) {
    showStatus('Please enter product name', 'error');
    return;
  }
  
  if (isNaN(newMrp) || newMrp <= 0) {
    showStatus('Please enter valid MRP', 'error');
    return;
  }
  
  // Check for duplicate product name (excluding current product)
  const duplicate = products.find((p, i) => i !== index && p.name.toLowerCase() === newName.toLowerCase());
  if (duplicate) {
    showStatus('Product name already exists!', 'error');
    return;
  }
  
  // Update product in the array
  products[index].name = newName.toUpperCase();
  products[index].mrp = newMrp;
  
  // Save to localStorage
  saveProductsToStorage(products);
  
  showStatus(`Product "${newName}" updated successfully!`, 'success');
  loadProductsList(); // Reload the list
}

  // NEW: Delete a product
  function deleteProduct(index) {
    const productName = products[index].name;
    
    if (confirm(`Are you sure you want to delete product "${productName}"?`)) {
      products.splice(index, 1);
      saveProductsToStorage(products);
      showStatus(`Product "${productName}" deleted successfully!`, 'success');
      loadProductsList(); // Reload the list
    }
  }

  // Initialize product management system
  function initProductManagement() {
      // Load products from localStorage
      products = loadProducts();
      
      // Add product button event
      $('#add-product-btn').click(function() {
          $('#add-product-modal').show();
      });
      
      // Save new product event
      $('#save-new-product').click(addNewProduct);
      
      // Close modal events
      $('#add-product-modal .close').click(function() {
          $('#add-product-modal').hide();
      });
      
      // NEW: Manage products button event
      $('#manage-products-btn').click(showManageProductsModal);
      
      // NEW: Close manage products modal
      $('#close-manage-products').click(function() {
          $('#manage-products-modal').hide();
      });
      
      // NEW: Search products in manage modal
      $('#search-product').on('input', loadProductsList);
  }

  // ================= DATA STORAGE FUNCTIONS =================
  
  // Generate a safe filename for patient data
  function getPatientFileName(patientName) {
    const safeName = patientName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    return `${DATA_PREFIX}${safeName}`;
  }

  // Load patient data from localStorage
  function loadPatientData(patientName) {
    try {
      const fileName = getPatientFileName(patientName);
      const data = localStorage.getItem(fileName);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      return [];
    }
  }

  // Save current bill data for a patient
  function savePatientData() {
    const name = $('#name').val().trim();
    if (!name) {
      showStatus('Please enter patient name', 'error');
      return;
    }

    // Get current date and time
    const today = new Date();
    const dateStr = today.getFullYear() + "/" + 
                    String(today.getMonth() + 1).padStart(2, '0') + "/" + 
                    String(today.getDate()).padStart(2, '0');
    
    const timeStr = String(today.getHours()).padStart(2, '0') + ":" + 
                    String(today.getMinutes()).padStart(2, '0') + ":" + 
                    String(today.getSeconds()).padStart(2, '0');

    // Create bill data object
    const billData = {
      date: dateStr,
      time: timeStr,
      timestamp: today.getTime(),
      products: [],
      subtotal: parseFloat($('#subtotal').text().replace('₹','')) || 0,
      discountPercent: parseInt($('#discount-percent').val()) || 0,
      discountFlat: parseFloat($('#discount-flat').val()) || 0,
      totalDiscount: parseFloat($('#total-discount').text().replace('₹','')) || 0,
      finalTotal: parseFloat($('#final-total').text().replace('₹','')) || 0
    };

    // Extract product data from table
    $('#products-body tr').each(function() {
      const productName = $(this).find('.product-search').val();
      const mrp = parseFloat($(this).find('.mrp-display').text()) || 0;
      const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
      const total = parseFloat($(this).find('.total-display').text().replace('₹','')) || 0;
      
      if (productName && quantity > 0) {
        billData.products.push({
          name: productName,
          mrp: mrp,
          quantity: quantity,
          total: total
        });
      }
    });

    // Validate that at least one product is added
    if (billData.products.length === 0) {
      showStatus('Please add at least one product', 'error');
      return;
    }

    // Load existing patient data and add new bill
    const patientData = loadPatientData(name);
    patientData.push(billData);
    
    // Save updated data to localStorage
    const fileName = getPatientFileName(name);
    localStorage.setItem(fileName, JSON.stringify(patientData));
    
    showStatus(`Data saved for ${name} on ${dateStr} ${timeStr}`, 'success');
    updatePatientList();
    updateBackupStatus();
  }

  // Update the patient list for autocomplete
  function updatePatientList() {
    const patientNames = [];
    
    // Extract all patient names from localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        const patientName = key.replace(DATA_PREFIX, '');
        const displayName = patientName.replace(/_/g, ' ');
        patientNames.push(displayName);
      }
    }
    
    patientNames.sort();
    
    // Update the datalist with patient names
    const datalist = $('#patient-list');
    datalist.empty();
    
    patientNames.forEach(name => {
      datalist.append(`<option value="${name}">`);
    });
  }

  // Display status messages to user
  function showStatus(message, type = 'info') {
    const statusDiv = $('#status-message');
    statusDiv.removeClass('status-success status-error status-info status-warning')
             .addClass(`status-${type} status-message`)
             .text(message)
             .show();
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      statusDiv.fadeOut();
    }, 5000);
  }

  // ================= BACKUP & RESTORE FUNCTIONS =================
  
  // Get all patient data from localStorage
  function getAllPatientData() {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        const patientName = key.replace(DATA_PREFIX, '');
        try {
          allData[patientName] = JSON.parse(localStorage.getItem(key));
        } catch (e) {
          console.error('Error parsing data for:', patientName);
        }
      }
    }
    return allData;
  }

  // Export all data to JSON file
  function exportToJSON() {
    const allData = {
      patients: getAllPatientData(),
      products: JSON.parse(localStorage.getItem(PRODUCTS_STORAGE_KEY) || '[]'),
      exportDate: new Date().toISOString(),
      exportType: 'full_backup'
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `patient_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // Update backup timestamp
    localStorage.setItem('last_backup', new Date().toISOString());
    updateBackupStatus();
    
    showStatus('Full data exported successfully!', 'success');
  }

  // Export data to CSV file
  function exportToCSV() {
    const allData = getAllPatientData();
    let csvContent = 'Patient Name,Date,Time,Product,MRP,Quantity,Total,Discount %,Discount Amount,Final Total\n';
    
    // Convert data to CSV format
    for (const patientName in allData) {
      if (allData.hasOwnProperty(patientName)) {
        const records = allData[patientName];
        records.forEach(record => {
          record.products.forEach(product => {
            csvContent += `"${patientName.replace(/_/g, ' ')}","${record.date}","${record.time}","${product.name}",${product.mrp},${product.quantity},${product.total},${record.discountPercent},${record.discountFlat},${record.finalTotal}\n`;
          });
        });
      }
    }
    
    const dataBlob = new Blob([csvContent], {type: 'text/csv'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `patient_backup_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('last_backup', new Date().toISOString());
    updateBackupStatus();
    
    showStatus('CSV exported successfully!', 'success');
  }

  // Import data from file
  function importFromFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        
        // Check if it's the new format with products or old format
        if (importedData.patients && importedData.products) {
          // New format with products
          restoreFullBackup(importedData);
        } else {
          // Old format - only patient data
          restorePatientDataOnly(importedData);
        }
        
      } catch (error) {
        showStatus('Error importing file: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
  }

  // Restore full backup (patients + products)
  function restoreFullBackup(importedData) {
    // Clear existing data
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX) || key === PRODUCTS_STORAGE_KEY) {
        localStorage.removeItem(key);
      }
    }
    
    // Restore patient data
    for (const patientName in importedData.patients) {
      if (importedData.patients.hasOwnProperty(patientName)) {
        localStorage.setItem(DATA_PREFIX + patientName, JSON.stringify(importedData.patients[patientName]));
      }
    }
    
    // Restore products
    if (importedData.products && importedData.products.length > 0) {
      localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(importedData.products));
      products = importedData.products; // Update in-memory products
    }
    
    updatePatientList();
    updateBackupStatus();
    showStatus('Full backup restored successfully!', 'success');
  }

  // Restore only patient data (backward compatibility)
  function restorePatientDataOnly(importedData) {
    const currentData = getAllPatientData();
    const mergedData = {...currentData, ...importedData};
    
    // Clear existing patient data
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(DATA_PREFIX)) {
        localStorage.removeItem(key);
      }
    }
    
    // Restore merged data
    for (const patientName in mergedData) {
      if (mergedData.hasOwnProperty(patientName)) {
        localStorage.setItem(DATA_PREFIX + patientName, JSON.stringify(mergedData[patientName]));
      }
    }
    
    updatePatientList();
    updateBackupStatus();
    showStatus('Patient data imported successfully!', 'success');
  }

  // Update backup status display
  function updateBackupStatus() {
    const lastBackup = localStorage.getItem('last_backup');
    if (lastBackup) {
      $('#last-backup-time').text(new Date(lastBackup).toLocaleString());
    } else {
      $('#last-backup-time').text('Never');
    }
    
    const allData = getAllPatientData();
    const patientCount = Object.keys(allData).length;
    const recordCount = Object.values(allData).reduce((total, records) => total + records.length, 0);
    const productCount = products.length;
    
    $('#backup-patient-count').text(patientCount);
    $('#backup-record-count').text(recordCount);
    $('#backup-product-count').text(productCount);
  }

  // ================= ENHANCED HISTORY MANAGEMENT =================
  function showEnhancedHistoryManagement() {
      const name = $('#name').val().trim();
      if (!name) {
          showStatus('Please enter patient name', 'error');
          return;
      }

      const patientData = loadPatientData(name);
      
      if (patientData.length === 0) {
          showStatus('No history found for this patient', 'error');
          return;
      }

      // Sort by timestamp (newest first)
      patientData.sort((a, b) => b.timestamp - a.timestamp);
      
      $('#history-patient-name').text(name);
      const historyList = $('#history-list');
      historyList.empty();
      
      // Add history management section
      const managementSection = `
          <div class="history-management">
              <h4><i class="fa fa-cog"></i> History Management</h4>
              <div class="history-actions">
                  <button class="btn btn-clear" id="delete-all-history">
                      <i class="fa fa-trash"></i> Delete All History
                  </button>
                  <button class="btn btn-export" id="export-patient-history">
                      <i class="fa fa-download"></i> Export Patient Data
                  </button>
              </div>
          </div>
      `;
      historyList.append(managementSection);
      
      // Display each history record
      patientData.forEach((record, index) => {
          const historyItem = `
              <div class="history-item" data-timestamp="${record.timestamp}">
                  <div class="history-date">
                      <span>Date: ${record.date} Time: ${record.time}</span>
                      <button class="delete-history-btn" data-timestamp="${record.timestamp}">
                          <i class="fa fa-trash"></i> Delete
                      </button>
                  </div>
                  <div class="history-products">
                      ${record.products.map(product => `
                          <div class="history-product">
                              <span>${product.name}</span>
                              <span>${product.quantity} × ₹${product.mrp.toFixed(2)} = ₹${product.total.toFixed(2)}</span>
                          </div>
                      `).join('')}
                  </div>
                  <div class="history-totals">
                      <div class="history-total-row">
                          <span>Total Amount:</span>
                          <span>₹${record.subtotal.toFixed(2)}</span>
                      </div>
                      <div class="history-total-row">
                          <span>Discount (${record.discountPercent}% + ₹${record.discountFlat}):</span>
                          <span>₹${record.totalDiscount.toFixed(2)}</span>
                      </div>
                      <div class="history-total-row final-amount">
                          <span>Final Payable Amount:</span>
                          <span>₹${record.finalTotal.toFixed(2)}</span>
                      </div>
                  </div>
              </div>
          `;
          historyList.append(historyItem);
      });
      
      // Add daily report section
      const dailyReportSection = `
          <div class="daily-report-section">
              <div class="daily-report-header">
                  <h4><i class="fa fa-calendar"></i> Daily Transaction Report</h4>
                  <div class="date-filter">
                      <input type="date" id="report-date" value="${new Date().toISOString().split('T')[0]}">
                      <button class="btn btn-save" id="load-daily-report">
                          <i class="fa fa-search"></i> Load Report
                      </button>
                  </div>
              </div>
              <div id="daily-report-content">
                  ${generateDailyReport(new Date().toISOString().split('T')[0])}
              </div>
          </div>
      `;
      historyList.append(dailyReportSection);
      
      // Attach event handlers
      attachHistoryManagementEvents(name);
      
      $('#history-modal').show();
  }

  // Attach event handlers for history management
  function attachHistoryManagementEvents(patientName) {
      // Delete single transaction
      $('.delete-history-btn').off().click(function(e) {
          e.stopPropagation();
          const timestamp = $(this).data('timestamp');
          showDeleteConfirmation(patientName, timestamp, false);
      });
      
      // Delete all history
      $('#delete-all-history').off().click(function() {
          showDeleteConfirmation(patientName, null, true);
      });
      
      // Export patient data
      $('#export-patient-history').off().click(function() {
          exportPatientHistory(patientName);
      });
      
      // Load daily report
      $('#load-daily-report').off().click(function() {
          const date = $('#report-date').val();
          $('#daily-report-content').html(generateDailyReport(date));
      });
  }

  // Show confirmation dialog for delete operations
  function showDeleteConfirmation(patientName, timestamp, deleteAll = false) {
      const message = deleteAll ? 
          'Are you sure you want to delete ALL history for this patient? This action cannot be undone.' :
          'Are you sure you want to delete this transaction? This action cannot be undone.';
      
      const confirmHtml = `
          <div class="confirm-delete">
              <strong>${message}</strong>
              <div class="confirm-buttons">
                  <button class="btn btn-clear confirm-yes">Yes, Delete</button>
                  <button class="btn btn-save confirm-no">Cancel</button>
              </div>
          </div>
      `;
      
      // Remove any existing confirmation
      $('.confirm-delete').remove();
      
      if (deleteAll) {
          $('#delete-all-history').after(confirmHtml);
      } else {
          $(`.delete-history-btn[data-timestamp="${timestamp}"]`).closest('.history-date').after(confirmHtml);
      }
      
      $('.confirm-yes').off().click(function() {
          if (deleteAll) {
              deleteAllPatientHistory(patientName);
          } else {
              deleteSingleTransaction(patientName, timestamp);
          }
      });
      
      $('.confirm-no').off().click(function() {
          $('.confirm-delete').remove();
      });
  }

  // Delete a single transaction
  function deleteSingleTransaction(patientName, timestamp) {
      const patientData = loadPatientData(patientName);
      const updatedData = patientData.filter(record => record.timestamp !== timestamp);
      
      const fileName = getPatientFileName(patientName);
      localStorage.setItem(fileName, JSON.stringify(updatedData));
      
      showStatus('Transaction deleted successfully', 'success');
      showEnhancedHistoryManagement(); // Refresh the view
      updateBackupStatus();
  }

  // Delete all history for a patient
  function deleteAllPatientHistory(patientName) {
      const fileName = getPatientFileName(patientName);
      localStorage.removeItem(fileName);
      
      showStatus(`All history deleted for ${patientName}`, 'success');
      $('#history-modal').hide();
      updatePatientList();
      updateBackupStatus();
  }

  // Export patient history to JSON file
  function exportPatientHistory(patientName) {
      const patientData = loadPatientData(patientName);
      const dataStr = JSON.stringify(patientData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `patient_${patientName.replace(/[^a-zA-Z0-9]/g, '_')}_history_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showStatus(`Patient history exported for ${patientName}`, 'success');
  }

  // Generate daily transaction report
  function generateDailyReport(date) {
    const allPatients = getAllPatientData();
    let reportHTML = '';
    let totalDayAmount = 0;
    let patientCount = 0;
    
    // Convert date from YYYY-MM-DD to YYYY/MM/DD format
    const formattedDate = date.replace(/-/g, '/');
    
    // Filter transactions for the selected date from ALL patients
    const dailyTransactions = {};
    
    for (const patientName in allPatients) {
        if (allPatients.hasOwnProperty(patientName)) {
            const displayName = patientName.replace(/_/g, ' ');
            const patientRecords = allPatients[patientName];
            
            const dayRecords = patientRecords.filter(record => record.date === formattedDate);
            
            if (dayRecords.length > 0) {
                dailyTransactions[displayName] = dayRecords;
                patientCount++;
                
                // Calculate total for this patient on this day
                const patientDayTotal = dayRecords.reduce((total, record) => total + record.finalTotal, 0);
                totalDayAmount += patientDayTotal;
            }
        }
    }
    
    if (Object.keys(dailyTransactions).length === 0) {
        return '<div class="no-history">No transactions found for ' + formattedDate + '</div>';
    }
    
    // Generate report HTML
    for (const [patientName, records] of Object.entries(dailyTransactions)) {
        const patientTotal = records.reduce((total, record) => total + record.finalTotal, 0);
        
        reportHTML += `
            <div class="patient-day-summary">
                <div class="patient-day-header">
                    <span class="patient-day-name">${patientName}</span>
                    <span class="patient-day-total">₹${patientTotal.toFixed(2)}</span>
                </div>
        `;
        
        records.forEach(record => {
            reportHTML += `
                <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-size: 12px; color: #666;">Time: ${record.time}</div>
                    <div style="margin-top: 4px;">
                        ${record.products.map(product => 
                            `<div style="font-size: 12px;">${product.name} (${product.quantity} × ₹${product.mrp.toFixed(2)}) = ₹${product.total.toFixed(2)}</div>`
                        ).join('')}
                    </div>
                    <div style="font-size: 12px; margin-top: 4px; font-weight: bold;">
                        Total: ₹${record.finalTotal.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        reportHTML += `</div>`;
    }
    
    // Add summary
    reportHTML = `
        <div style="margin-bottom: 15px; padding: 10px; background: #d4edda; border-radius: 6px; text-align: center;">
            <strong>Daily Summary for ${formattedDate}:</strong> ${patientCount} patients, Total Amount: ₹${totalDayAmount.toFixed(2)}
        </div>
        ${reportHTML}
    `;
    
    return reportHTML;
  }

  // ================= AUTOCOMPLETE FUNCTIONALITY =================
  function initAutocompleteForRow(row) {
    row.find('.product-search').autocomplete({
      source: function(request, response) {
        const term = request.term.toLowerCase();
        const matches = products.filter(p => p.name.toLowerCase().includes(term)).map(p => p.name);
        response(matches);
      },
      minLength: 1,
      select: function(e, ui) {
        const product = products.find(p => p.name === ui.item.value);
        if (product) {
          row.find('.mrp-display').text(product.mrp.toFixed(2));
          calculateRowTotal(row);
        }
      }
    });
  }

  // ================= CALCULATION FUNCTIONS =================
  function calculateRowTotal(row) {
    const mrp = parseFloat(row.find('.mrp-display').text()) || 0;
    let qtyVal = parseInt(row.find('.quantity-input').val());
    if (isNaN(qtyVal) || qtyVal <= 0) {
      qtyVal = 0;
      row.find('.quantity-input').val("");
      row.find('.quantity-input').addClass("no-qty");
    } else {
      row.find('.quantity-input').removeClass("no-qty");
    }
    const total = mrp * qtyVal;
    row.find('.total-display').text('₹' + total.toFixed(2));
    calculateTotal();
  }

  function calculateTotal() {
    let subtotal = 0;
    let productCount = 0;
    $('#products-body tr').each(function() {
      const total = parseFloat($(this).find('.total-display').text().replace('₹','')) || 0;
      const qtyVal = parseInt($(this).find('.quantity-input').val());
      if (!isNaN(qtyVal) && qtyVal > 0) productCount++;
      subtotal += total;
    });
    
    $('#subtotal').text('₹' + subtotal.toFixed(2));
    
    const discountPercent = parseInt($('#discount-percent').val()) || 0;
    const discountFlat = parseFloat($('#discount-flat').val()) || 0;
    
    const discountFromPercent = subtotal * (discountPercent / 100);
    const totalDiscount = discountFromPercent + discountFlat;
    const finalTotal = Math.max(0, subtotal - totalDiscount);
    
    $('#total-discount').text('₹' + totalDiscount.toFixed(2));
    $('#final-total').text('₹' + finalTotal.toFixed(2));
    $('#total-products-display').text("Count: " + productCount);
    
    const discountMessage = $('#discount-message');
    if (discountPercent > 0 || discountFlat > 0) {
      let message = "";
      if (discountPercent > 0 && discountFlat > 0) {
        message = `Discount applied: ${discountPercent}% (₹${discountFromPercent.toFixed(2)}) + ₹${discountFlat.toFixed(2)} = ₹${totalDiscount.toFixed(2)}`;
      } else if (discountPercent > 0) {
        message = `Discount applied: ${discountPercent}% = ₹${discountFromPercent.toFixed(2)}`;
      } else if (discountFlat > 0) {
        message = `Discount applied: ₹${discountFlat.toFixed(2)}`;
      }
      discountMessage.text(message).show();
    } else {
      discountMessage.hide();
    }
  }

  // Attach events to quantity inputs
  function attachEvents() {
    $('.quantity-input').off().on('input', function() {
      calculateRowTotal($(this).closest('tr'));
    });
  }

  // ================= INITIALIZATION =================
  
  // Initialize product management FIRST
  initProductManagement();
  
  // Then initialize autocomplete
  initAutocompleteForRow($('#products-body tr'));
  attachEvents();
  
  updatePatientList();
  updateBackupStatus();
  
  // Button event handlers
  $('#save-btn').click(savePatientData);
  $('#history-btn').click(showEnhancedHistoryManagement);
  $('#backup-btn').click(function() {
    $('#backup-modal').show();
  });
  
  // Backup functionality
  $('#export-json').click(exportToJSON);
  $('#export-csv').click(exportToCSV);
  $('#import-btn').click(function() {
    $('#import-file').click();
  });
  
  $('#import-file').change(function(e) {
    if (e.target.files.length > 0) {
      importFromFile(e.target.files[0]);
    }
  });

  // Modal close handlers
  $('.close').click(function() {
    $('#history-modal, #backup-modal, #add-product-modal, #manage-products-modal').hide();
  });
  
  $(window).click(function(event) {
    if ($(event.target).is('.modal')) {
      $('#history-modal, #backup-modal, #add-product-modal, #manage-products-modal').hide();
    }
  });

  // Add row button
  $('#add-row').click(function() {
    const newRow = $(`
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    `);
    $('#products-body').append(newRow);
    initAutocompleteForRow(newRow);
    attachEvents();
  });

  // Clear all button
  $('#clear-all').click(function() {
    $('#products-body').empty();
    const newRow = $(`
      <tr>
        <td><input type="text" class="product-search" placeholder="Search product..."></td>
        <td><span class="mrp-display">0.00</span></td>
        <td><input type="number" class="quantity-input" placeholder=""></td>
        <td><span class="total-display">₹0.00</span></td>
      </tr>
    `);
    $('#products-body').append(newRow);
    initAutocompleteForRow(newRow);
    attachEvents();
    
    $('#name').val("");
    $('#discount-percent').val("");
    $('#discount-flat').val("");
    calculateTotal();
  });
  // Clear All Button in Drop Down Menu
$('#clear-all-menu').click(function() {
  $('#clear-all').click(); // This calls your existing function
  $('#hdrMenu').hide(); // Optional: hide the dropdown menu
});
  
  

  // Discount input handlers
  $('#discount-percent, #discount-flat').on('input', calculateTotal);

  // ================= SCREENSHOT FUNCTIONALITY =================
  $('#screenshot-btn').click(function() {
    const name = $('#name').val() || "NoName";
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}${mm}${dd}`;
    const fileName = `${name}_${dateStr}.png`;
    
    // Use html2canvas to capture the billing container
    html2canvas(document.querySelector("#billing-container")).then(canvas => {
      const link = document.createElement("a");
      link.download = fileName;
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  });
});




// Drop Down menu toggle
  $('#hdrMenuBtn').on('click', function(e){ e.stopPropagation(); $('#hdrMenu').toggle(); });
  $(document).on('click', function(){ $('#hdrMenu').hide(); });

  // quick add row on Enter in last product name
  $(document).on('keydown', function(e){
    if(e.key === 'Enter' && $(':focus').hasClass('prodName')){
      const focused = $(':focus');
      const tr = focused.closest('tr');
      if(tr.is(':last-child')){
        $('#productRows').append(renderRowElement(createEmptyRow()));
        recalcAll();
      }
    }
  });
</script>
</body>
</html>
